<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="description" content="1. MySql中常用工具
"><meta name="keywords" content="czq's Blog,  博客, 个人网站, 互联网, java,Linux,Web"><meta name="theme-color" content="#000000"><meta property="og:title" content="MySQL学习笔记高级篇（四） - Czq's Blog"><meta property="og:type" content="article"><meta property="og:description" content="1. MySql中常用工具
"><meta property="article:published_time" content="2020-09-14T16:00:00Z"><meta property="article:author" content="陈子琦"><meta property="article:tag" content="mysql"><meta property="article:tag" content="后端"><meta property="article:tag" content="性能"><meta property="og:image" content="https://czqu.cc/img/avatar-boy.webp"><meta property="og:url" content="https://czqu.cc/mysql-note-a04.html"><meta property="og:site_name" content="Czq's Blog"><title>MySQL学习笔记高级篇（四） - Czq's Blog</title><link rel="manifest" href="/pwa/manifest.json"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://czqu.cc/mysql-note-a04.html"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/hux-blog.min.css"><link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><script></script></head><body ontouchstart=""><script src="/js/qin-blog.js" type="text/javascript"></script><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Czq's Blog</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archive/">Archive</a></li><li><a href="/more/">More</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(e){0<$navbar.className.indexOf("in")?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){e.target!=$toggle&&"icon-bar"!=e.target.className&&__HuxNav__.close()})</script><style type="text/css">header.intro-header{position:relative;background-image:url(/img/home-bg-notdimmed.webp)}</style><header class="intro-header"><div class="header-mask"></div><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/archive/?tag=mysql" title="mysql">mysql</a> <a class="tag" href="/archive/?tag=%E5%90%8E%E7%AB%AF" title="后端">后端</a> <a class="tag" href="/archive/?tag=%E6%80%A7%E8%83%BD" title="性能">性能</a></div><h1>MySQL学习笔记高级篇（四）</h1><h2 class="subheading"></h2><span class="meta">Posted by 陈子琦 on September 14, 2020</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><h3 id="1-mysql中常用工具">1. MySql中常用工具</h3><h4 id="11-mysql">1.1 mysql</h4><p>该mysql不是指mysql服务，而是指mysql的客户端工具。</p><p>语法 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mysql [options] [database]
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="111-连接选项">1.1.1 连接选项</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>参数 ： 
	-u, --user=name			指定用户名
	-p, --password[=name]	指定密码
	-h, --host=name			指定服务器IP或域名
	-P, --port=#			指定连接端口

示例 ：
	mysql -h 127.0.0.1 -P 3306 -u root -p
	
	mysql -h127.0.0.1 -P3306 -uroot -p2143
	
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="112-执行选项">1.1.2 执行选项</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>-e, --execute=name		执行SQL语句并退出
</pre></td></tr></tbody></table></code></pre></div></div><p>此选项可以在Mysql客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这种方式尤其方便。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>示例：
	mysql -uroot -p2143 db01 -e "select * from tb_book";
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555325632715.png" alt="1555325632715"></p><h4 id="12-mysqladmin">1.2 mysqladmin</h4><p>mysqladmin 是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。</p><p>可以通过 ： mysqladmin --help 指令查看帮助文档</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555326108697.png" alt="1555326108697"></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>示例 ：
	mysqladmin -uroot -p2143 create 'test01';  
	mysqladmin -uroot -p2143 drop 'test01';
	mysqladmin -uroot -p2143 version;
	
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="13-mysqlbinlog">1.3 mysqlbinlog</h4><p>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到mysqlbinlog 日志管理工具。</p><p>语法 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>mysqlbinlog [options]  log-files1 log-files2 ...

选项：
	
	-d, --database=name : 指定数据库名称，只列出指定的数据库相关操作。
	
	-o, --offset=# : 忽略掉日志中的前n行命令。
	
	-r,--result-file=name : 将输出的文本格式日志输出到指定文件。
	
	-s, --short-form : 显示简单格式， 省略掉一些信息。
	
	--start-datatime=date1  --stop-datetime=date2 : 指定日期间隔内的所有日志。
	
	--start-position=pos1 --stop-position=pos2 : 指定位置间隔内的所有日志。
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="14-mysqldump">1.4 mysqldump</h4><p>mysqldump 客户端工具用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。</p><p>语法 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>mysqldump [options] db_name [tables]

mysqldump [options] --database/-B db1 [db2 db3...]

mysqldump [options] --all-databases/-A
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="141-连接选项">1.4.1 连接选项</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>参数 ： 
	-u, --user=name			指定用户名
	-p, --password[=name]	指定密码
	-h, --host=name			指定服务器IP或域名
	-P, --port=#			指定连接端口
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="142-输出内容选项">1.4.2 输出内容选项</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>参数：
	--add-drop-database		在每个数据库创建语句前加上 Drop database 语句
	--add-drop-table		在每个表创建语句前加上 Drop table 语句 , 默认开启 ; 不开启 (--skip-add-drop-table)
	
	-n, --no-create-db		不包含数据库的创建语句
	-t, --no-create-info	不包含数据表的创建语句
	-d --no-data			不包含数据
	
	 -T, --tab=name			自动生成两个文件：一个.sql文件，创建表结构的语句；
	 						一个.txt文件，数据文件，相当于select into outfile  
</pre></td></tr></tbody></table></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>示例 ： 
	mysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table &gt; a
	
	mysqldump -uroot -p2143 -T /tmp test city
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/20200914095434.png" alt="1555501806693"></p><h4 id="15-mysqlimportsource">1.5 mysqlimport/source</h4><p>mysqlimport 是客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件。</p><p>语法：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mysqlimport [options]  db_name  textfile1  [textfile2...]
</pre></td></tr></tbody></table></code></pre></div></div><p>示例：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mysqlimport -uroot -p2143 test /tmp/city.txt
</pre></td></tr></tbody></table></code></pre></div></div><p>如果需要导入sql文件,可以使用mysql中的source 指令 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>source /root/tb_book.sql
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="16-mysqlshow">1.6 mysqlshow</h4><p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。</p><p>语法：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mysqlshow [options] [db_name [table_name [col_name]]]
</pre></td></tr></tbody></table></code></pre></div></div><p>参数：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>--count		显示数据库及表的统计信息（数据库，表 均可以不指定）

-i			显示指定数据库或者指定表的状态信息
</pre></td></tr></tbody></table></code></pre></div></div><p>示例：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>#查询每个数据库的表的数量及表中记录的数量
mysqlshow -uroot -p2143 --count

#查询test库中每个表中的字段书，及行数
mysqlshow -uroot -p2143 test --count

#查询test库中book表的详细情况
mysqlshow -uroot -p2143 test book --count

</pre></td></tr></tbody></table></code></pre></div></div><h3 id="2-mysql-日志">2. Mysql 日志</h3><p>在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的方方面面，以帮助数据库管理员追踪数据库曾经发生过的各种事件。MySQL 也不例外，在 MySQL 中，有 4 种不同的日志，分别是错误日志、二进制日志（BINLOG 日志）、查询日志和慢查询日志，这些日志记录着数据库在不同方面的踪迹。</p><h4 id="21-错误日志">2.1 错误日志</h4><p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志。</p><p>该日志是默认开启的 ， 默认存放目录为 mysql 的数据目录（var/lib/mysql）, 默认的日志文件名为 hostname.err（hostname是主机名）。</p><p>查看日志位置指令 ：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">show</span> <span class="n">variables</span> <span class="k">like</span> <span class="s1">'log_error%'</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1553993244446.png" alt="1553993244446"></p><p>查看日志内容 ：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">tail</span> <span class="nt">-f</span> /var/lib/mysql/xaxh-server.err
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1553993537874.png" alt="1553993537874"></p><h4 id="22-二进制日志">2.2 二进制日志</h4><h5 id="221概述">2.2.1概述</h5><p>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但是不包括数据查询语句。此日志对于灾难时的数据恢复起着极其重要的作用，MySQL的主从复制， 就是通过该binlog实现的。</p><p>二进制日志，默认情况下是没有开启的，需要到MySQL的配置文件中开启，并配置MySQL日志的格式。</p><p>配置文件位置 : /usr/my.cnf</p><p>日志存放位置 : 配置时，给定了文件名但是没有指定路径，日志默认写入Mysql的数据目录。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>#配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002
log_bin=mysqlbin

#配置二进制日志的格式
binlog_format=STATEMENT

</pre></td></tr></tbody></table></code></pre></div></div><h5 id="222-日志格式">2.2.2 日志格式</h5><p><strong>STATEMENT</strong></p><p>该日志格式在日志文件中记录的都是SQL语句（statement），每一条对数据进行修改的SQL都会记录在日志文件中，通过Mysql提供的mysqlbinlog工具，可以清晰的查看到每条语句的文本。主从复制的时候，从库（slave）会将日志解析为原文本，并在从库重新执行一次。</p><p><strong>ROW</strong></p><p>该日志格式在日志文件中记录的是每一行的数据变更，而不是记录SQL语句。比如，执行SQL语句 ： update tb_book set status=’1’ , 如果是STATEMENT 日志格式，在日志中会记录一行SQL文件； 如果是ROW，由于是对全表进行更新，也就是每一行记录都会发生变更，ROW 格式的日志中会记录每一行的数据变更。</p><p><strong>MIXED</strong></p><p>这是目前MySQL默认的日志格式，即混合了STATEMENT 和 ROW两种格式。默认情况下采用STATEMENT，但是在一些特殊情况下采用ROW来进行记录。MIXED 格式能尽量利用两种模式的优点，而避开他们的缺点。</p><h5 id="223-日志读取">2.2.3 日志读取</h5><p>由于日志以二进制方式存储，不能直接读取，需要用mysqlbinlog工具来查看，语法如下 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>mysqlbinlog log-file；

</pre></td></tr></tbody></table></code></pre></div></div><p><strong>查看STATEMENT格式日志</strong></p><p>执行插入语句 ：</p><pre><code class="language-SQL">insert into tb_book values(null,'Lucene','2088-05-01','0');
</code></pre><p>查看日志文件 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554079717375.png" alt="1554079717375"></p><p>mysqlbin.index : 该文件是日志索引文件 ， 记录日志的文件名；</p><p>mysqlbing.000001 ：日志文件</p><p>查看日志内容 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>mysqlbinlog mysqlbing.000001；

</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554080016778.png" alt="1554080016778"></p><p><strong>查看ROW格式日志</strong></p><p>配置 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>#配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002
log_bin=mysqlbin

#配置二进制日志的格式
binlog_format=ROW

</pre></td></tr></tbody></table></code></pre></div></div><p>插入数据 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">insert</span> <span class="k">into</span> <span class="n">tb_book</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'SpringCloud实战'</span><span class="p">,</span><span class="s1">'2088-05-05'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>如果日志格式是 ROW , 直接查看数据 , 是查看不懂的 ; 可以在mysqlbinlog 后面加上参数 -vv</p><pre><code class="language-SQL">mysqlbinlog -vv mysqlbin.000002 
</code></pre><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554095452022.png" alt="1554095452022"></p><h5 id="224-日志删除">2.2.4 日志删除</h5><p>对于比较繁忙的系统，由于每天生成日志量大 ，这些日志如果长时间不清楚，将会占用大量的磁盘空间。下面我们将会讲解几种删除日志的常见方法 ：</p><p><strong>方式一</strong></p><p>通过 Reset Master 指令删除全部 binlog 日志，删除之后，日志编号，将从 xxxx.000001重新开始 。</p><p>查询之前 ，先查询下日志文件 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554118609489.png" alt="1554118609489"></p><p>执行删除日志指令：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Reset Master
</pre></td></tr></tbody></table></code></pre></div></div><p>执行之后， 查看日志文件 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554118675264.png" alt="1554118675264"></p><p><strong>方式二</strong></p><p>执行指令 <code class="language-plaintext highlighter-rouge">purge master logs to 'mysqlbin.******'</code> ，该命令将删除 <code class="language-plaintext highlighter-rouge">******</code> 编号之前的所有日志。</p><p><strong>方式三</strong></p><p>执行指令 <code class="language-plaintext highlighter-rouge">purge master logs before 'yyyy-mm-dd hh24:mi:ss'</code> ，该命令将删除日志为 “yyyy-mm-dd hh24:mi:ss” 之前产生的所有日志 。</p><p><strong>方式四</strong></p><p>设置参数 --expire_logs_days=# ，此参数的含义是设置日志的过期天数， 过了指定的天数后日志将会被自动删除，这样将有利于减少DBA 管理日志的工作量。</p><p>配置如下 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554125506938.png" alt="1554125506938"></p><h4 id="23-查询日志">2.3 查询日志</h4><p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。</p><p>默认情况下， 查询日志是未开启的。如果需要开启查询日志，可以设置以下配置 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>#该选项用来开启查询日志 ， 可选值 ： 0 或者 1 ； 0 代表关闭， 1 代表开启 
general_log=1

#设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name.log 
general_log_file=file_name

</pre></td></tr></tbody></table></code></pre></div></div><p>在 mysql 的配置文件 /usr/my.cnf 中配置如下内容 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554128184632.png" alt="1554128184632"></p><p>配置完毕之后，在数据库执行以下操作 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>select * from tb_book;
select * from tb_book where id = 1;
update tb_book set name = 'lucene入门指南' where id = 5;
select * from tb_book where id &lt; 8;

</pre></td></tr></tbody></table></code></pre></div></div><p>执行完毕之后， 再次来查询日志文件 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554128089851.png" alt="1554128089851"></p><h4 id="24-慢查询日志">2.4 慢查询日志</h4><p>慢查询日志记录了所有执行时间超过参数 long_query_time 设置值并且扫描记录数不小于 min_examined_row_limit 的所有的SQL语句的日志。long_query_time 默认为 10 秒，最小为 0， 精度可以到微秒。</p><h5 id="241-文件位置和格式">2.4.1 文件位置和格式</h5><p>慢查询日志默认是关闭的 。可以通过两个参数来控制慢查询日志 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre># 该参数用来控制慢查询日志是否开启， 可取值： 1 和 0 ， 1 代表开启， 0 代表关闭
slow_query_log=1 

# 该参数用来指定慢查询日志的文件名
slow_query_log_file=slow_query.log

# 该选项用来配置查询的时间限制， 超过这个时间将认为值慢查询， 将需要进行日志记录， 默认10s
long_query_time=10

</pre></td></tr></tbody></table></code></pre></div></div><h5 id="242-日志的读取">2.4.2 日志的读取</h5><p>和错误日志、查询日志一样，慢查询日志记录的格式也是纯文本，可以被直接读取。</p><p>1） 查询long_query_time 的值。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554130333472.png" alt="1554130333472"></p><p>2） 执行查询操作</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span><span class="n">price</span><span class="p">,</span><span class="n">num</span> <span class="p">,</span><span class="n">status</span> <span class="k">from</span> <span class="n">tb_item</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554130448709.png" alt="1554130448709"></p><p>由于该语句执行时间很短，为0s ， 所以不会记录在慢查询日志中。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>select * from tb_item where title like '%阿尔卡特 (OT-927) 炭黑 联通3G手机 双卡双待165454%' ;

</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554130532577.png" alt="1554130532577"></p><p>该SQL语句 ， 执行时长为 26.77s ，超过10s ， 所以会记录在慢查询日志文件中。</p><p>3） 查看慢查询日志文件</p><p>直接通过cat 指令查询该日志文件 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554130669360.png" alt="1554130669360"></p><p>如果慢查询日志内容很多， 直接查看文件，比较麻烦， 这个时候可以借助于mysql自带的 mysqldumpslow 工具， 来对慢查询日志进行分类汇总。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554130856485.png" alt="1554130856485"></p><h3 id="3-mysql复制">3. Mysql复制</h3><h4 id="31-复制概述">3.1 复制概述</h4><p>复制是指将主数据库的DDL 和 DML 操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。</p><p>MySQL支持一台主库同时向多台从库进行复制， 从库同时也可以作为其他从服务器的主库，实现链状复制。</p><h4 id="32-复制原理">3.2 复制原理</h4><p>MySQL 的主从复制原理如下。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1.jpg" alt="1554423698190"></p><p>从上层来看，复制分成三步：</p><ul><li>Master 主库在事务提交时，会把数据变更作为时间 Events 记录在二进制日志文件 Binlog 中。</li><li><p>主库推送二进制日志文件 Binlog 中的日志事件到从库的中继日志 Relay Log 。</p></li><li>slave重做中继日志中的事件，将改变反映它自己的数据。</li></ul><h4 id="33-复制优势">3.3 复制优势</h4><p>MySQL 复制的有点主要包含以下三个方面：</p><ul><li><p>主库出现问题，可以快速切换到从库提供服务。</p></li><li><p>可以在从库上执行查询操作，从主库中更新，实现读写分离，降低主库的访问压力。</p></li><li><p>可以在从库中执行备份，以避免备份期间影响主库的服务。</p></li></ul><h4 id="34-搭建步骤">3.4 搭建步骤</h4><h5 id="341-master">3.4.1 master</h5><p>1） 在master 的配置文件（/usr/my.cnf）中，配置如下内容：</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c">#mysql 服务ID,保证整个集群环境中唯一
</span><span class="py">server-id</span><span class="p">=</span><span class="s">1</span>

<span class="c">#mysql binlog 日志的存储路径和文件名
</span><span class="py">log-bin</span><span class="p">=</span><span class="s">/var/lib/mysql/mysqlbin</span>

<span class="c">#错误日志,默认已经开启
#log-err
</span>
<span class="c">#mysql的安装目录
#basedir
</span>
<span class="c">#mysql的临时目录
#tmpdir
</span>
<span class="c">#mysql的数据存放目录
#datadir
</span>
<span class="c">#是否只读,1 代表只读, 0 代表读写
</span><span class="py">read-only</span><span class="p">=</span><span class="s">0</span>

<span class="c">#忽略的数据, 指不需要同步的数据库
</span><span class="py">binlog-ignore-db</span><span class="p">=</span><span class="s">mysql</span>

<span class="c">#指定同步的数据库
#binlog-do-db=db01
</span></pre></td></tr></tbody></table></code></pre></div></div><p>2） 执行完毕之后，需要重启Mysql：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">service</span> <span class="n">mysql</span> <span class="k">restart</span> <span class="err">；</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>3） 创建同步数据的账户，并且进行授权操作：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">grant</span> <span class="n">replication</span> <span class="n">slave</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'itcast'</span><span class="o">@</span><span class="s1">'192.168.192.131'</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">'itcast'</span><span class="p">;</span>	

<span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>4） 查看master状态：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554477759735.png" alt="1554477759735"></p><p>字段含义：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>File : 从哪个日志文件开始推送日志文件 
Position ： 从哪个位置开始推送日志
Binlog_Ignore_DB : 指定不需要同步的数据库
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="342-slave">3.4.2 slave</h5><p>1） 在 slave 端配置文件中，配置如下内容：</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c">#mysql服务端ID,唯一
</span><span class="py">server-id</span><span class="p">=</span><span class="s">2</span>

<span class="c">#指定binlog日志
</span><span class="py">log-bin</span><span class="p">=</span><span class="s">/var/lib/mysql/mysqlbin</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>2） 执行完毕之后，需要重启Mysql：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>service mysql restart；
</pre></td></tr></tbody></table></code></pre></div></div><p>3） 执行如下指令 ：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">change</span> <span class="n">master</span> <span class="k">to</span> <span class="n">master_host</span><span class="o">=</span> <span class="s1">'192.168.192.130'</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="s1">'itcast'</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="s1">'itcast'</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="s1">'mysqlbin.000001'</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">413</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>指定当前从库对应的主库的IP地址，用户名，密码，从哪个日志文件开始的那个位置开始同步推送日志。</p><p>4） 开启同步操作</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>start slave;

show slave status;
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554479387365.png" alt="1554479387365"></p><p>5） 停止同步操作</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>stop slave;
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="343-验证同步操作">3.4.3 验证同步操作</h5><p>1） 在主库中创建数据库，创建表，并插入数据 ：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">database</span> <span class="n">db01</span><span class="p">;</span>

<span class="k">user</span> <span class="n">db01</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="k">user</span><span class="p">(</span>
	<span class="n">id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span><span class="p">,</span>
	<span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
	<span class="n">sex</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">sex</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'Tom'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">sex</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'Trigger'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">sex</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'Dawn'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>2） 在从库中查询数据，进行验证 ：</p><p>在从库中，可以查看到刚才创建的数据库：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554544658640.png" alt="1554544658640"></p><p>在该数据库中，查询user表中的数据：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1554544679538.png" alt="1554544679538"></p><h3 id="4-综合案例">4. 综合案例</h3><h4 id="41-需求分析">4.1 需求分析</h4><p>在业务系统中，需要记录当前业务系统的访问日志，该访问日志包含：操作人，操作时间，访问类，访问方法，请求参数，请求结果，请求结果类型，请求时长 等信息。记录详细的系统访问日志，主要便于对系统中的用户请求进行追踪，并且在系统 的管理后台可以查看到用户的访问记录。</p><p>记录系统中的日志信息，可以通过Spring 框架的AOP来实现。具体的请求处理流程，如下：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555075760661.png" alt="1555075760661"></p><h4 id="42-搭建案例环境">4.2 搭建案例环境</h4><h5 id="421-数据库表">4.2.1 数据库表</h5><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">mysql_demo</span> <span class="k">DEFAULT</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8mb4</span> <span class="err">；</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`brand`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'品牌名称'</span><span class="p">,</span>
  <span class="nv">`first_char`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'品牌首字母'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>



<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`item`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">COMMENT</span> <span class="s1">'商品id'</span><span class="p">,</span>
  <span class="nv">`title`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'商品标题'</span><span class="p">,</span>
  <span class="nv">`price`</span> <span class="nb">double</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'商品价格，单位为：元'</span><span class="p">,</span>
  <span class="nv">`num`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'库存数量'</span><span class="p">,</span>
  <span class="nv">`categoryid`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'所属类目，叶子类目'</span><span class="p">,</span>
  <span class="nv">`status`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'商品状态，1-正常，2-下架，3-删除'</span><span class="p">,</span>
  <span class="nv">`sellerid`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'商家ID'</span><span class="p">,</span>
  <span class="nv">`createtime`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'创建时间'</span><span class="p">,</span>
  <span class="nv">`updatetime`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'更新时间'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COMMENT</span><span class="o">=</span><span class="s1">'商品表'</span><span class="p">;</span>



<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`user`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`username`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`password`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">96</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`birthday`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`sex`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`email`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`phone`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`qq`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`operation_log`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">COMMENT</span> <span class="s1">'ID'</span><span class="p">,</span>
  <span class="nv">`operate_class`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'操作类'</span><span class="p">,</span>
  <span class="nv">`operate_method`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'操作方法'</span><span class="p">,</span>
  <span class="nv">`return_class`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'返回值类型'</span><span class="p">,</span>
  <span class="nv">`operate_user`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'操作用户'</span><span class="p">,</span>
  <span class="nv">`operate_time`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'操作时间'</span><span class="p">,</span>
  <span class="nv">`param_and_value`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'请求参数名及参数值'</span><span class="p">,</span>
  <span class="nv">`cost_time`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'执行方法耗时, 单位 ms'</span><span class="p">,</span>
  <span class="nv">`return_value`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'返回值'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span>  <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></pre></div></div><h5 id="422-pomxml">4.2.2 pom.xml</h5><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;properties&gt;</span>
  <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
  <span class="nt">&lt;maven.compiler.source&gt;</span>1.7<span class="nt">&lt;/maven.compiler.source&gt;</span>
  <span class="nt">&lt;maven.compiler.target&gt;</span>1.7<span class="nt">&lt;/maven.compiler.target&gt;</span>

  <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
  <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
  <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
  <span class="nt">&lt;spring.version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
  <span class="nt">&lt;slf4j.version&gt;</span>1.6.6<span class="nt">&lt;/slf4j.version&gt;</span>
  <span class="nt">&lt;log4j.version&gt;</span>1.2.12<span class="nt">&lt;/log4j.version&gt;</span>
  <span class="nt">&lt;mybatis.version&gt;</span>3.4.5<span class="nt">&lt;/mybatis.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>

<span class="nt">&lt;dependencies&gt;</span> <span class="c">&lt;!-- spring --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.6.8<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.16.16<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-orm<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-tx<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.servlet.jsp<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jsp-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>


  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>log4j<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>log4j<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${log4j.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${mybatis.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-spring<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.3.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>c3p0<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.9.1.2<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.1.5<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.9.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.9.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>

  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-annotations<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.9.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>




 <span class="nt">&lt;build&gt;</span>
   <span class="nt">&lt;plugins&gt;</span>
     <span class="nt">&lt;plugin&gt;</span>
       <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.maven<span class="nt">&lt;/groupId&gt;</span>
       <span class="nt">&lt;artifactId&gt;</span>tomcat7-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
       <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
       <span class="nt">&lt;configuration&gt;</span>
         <span class="nt">&lt;port&gt;</span>8080<span class="nt">&lt;/port&gt;</span>
         <span class="nt">&lt;path&gt;</span>/<span class="nt">&lt;/path&gt;</span>
         <span class="nt">&lt;uriEncoding&gt;</span>utf-8<span class="nt">&lt;/uriEncoding&gt;</span>
       <span class="nt">&lt;/configuration&gt;</span>
     <span class="nt">&lt;/plugin&gt;</span>
   <span class="nt">&lt;/plugins&gt;</span>
 <span class="nt">&lt;/build&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="423-webxml">4.2.3 web.xml</h5><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>
       <span class="na">version=</span><span class="s">"2.5"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 解决post乱码 --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>utf-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>forceEncoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath:applicationContext.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>


    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>springmvc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="c">&lt;!-- 指定加载的配置文件 ，通过参数contextConfigLocation加载--&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath:springmvc.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>springmvc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.do<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;welcome-file-list&gt;</span>
      <span class="nt">&lt;welcome-file&gt;</span>log-datalist.html<span class="nt">&lt;/welcome-file&gt;</span>
    <span class="nt">&lt;/welcome-file-list&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="424-dbproperties">4.2.4 db.properties</h5><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="py">jdbc.driver</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">jdbc.url</span><span class="p">=</span><span class="s">jdbc:mysql://192.168.142.128:3306/mysql_demo</span>
<span class="py">jdbc.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">jdbc.password</span><span class="p">=</span><span class="s">itcast</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="425-applicationcontextxml">4.2.5 applicationContext.xml</h5><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
	   <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
                            http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
                            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 加载配置文件 --&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:db.properties"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 配置 spring 创建容器时要扫描的包 --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"cn.itcast"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;context:exclude-filter</span> <span class="na">type=</span><span class="s">"annotation"</span> <span class="na">expression=</span><span class="s">"org.springframework.stereotype.Controller"</span><span class="nt">&gt;</span>	
        <span class="nt">&lt;/context:exclude-filter&gt;</span>
    <span class="nt">&lt;/context:component-scan&gt;</span>

    <span class="c">&lt;!-- 配置 MyBatis 的 Session 工厂 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"typeAliasesPackage"</span> <span class="na">value=</span><span class="s">"cn.itcast.pojo"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- 配置数据源 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClass"</span> <span class="na">value=</span><span class="s">"${jdbc.driver}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- 配置 Mapper 扫描器 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"basePackage"</span> <span class="na">value=</span><span class="s">"cn.itcast.mapper"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- 配置事务管理器 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- 配置事务的注解驱动 --&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;&lt;/tx:annotation-driven&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="426-springmvcxml">4.2.6 springmvc.xml</h5><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:mvc=</span><span class="s">"http://www.springframework.org/schema/mvc"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/mvc
            http://www.springframework.org/schema/mvc/spring-mvc.xsd
            http://www.springframework.org/schema/aop
            http://www.springframework.org/schema/aop/spring-aop.xsd
            http://www.springframework.org/schema/context
            http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"cn.itcast.controller"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>

    <span class="nt">&lt;mvc:annotation-driven&gt;&lt;/mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;aop:aspectj-autoproxy</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="427-导入基础工程">4.2.7 导入基础工程</h5><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555076434270.png" alt="1555076434270"></p><h4 id="43-通过aop记录操作日志">4.3 通过AOP记录操作日志</h4><h5 id="431-自定义注解">4.3.1 自定义注解</h5><p>通过自定义注解，来标示方法需不需要进行记录日志，如果该方法在访问时需要记录日志，则在该方法上标示该注解既可。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">OperateLog</span> <span class="o">{</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="432-定义通知类">4.3.2 定义通知类</h5><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OperateAdvice</span> <span class="o">{</span>
   
   <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">OperateAdvice</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   
   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">OperationLogService</span> <span class="n">operationLogService</span><span class="o">;</span>
   

   <span class="nd">@Around</span><span class="o">(</span><span class="s">"execution(* cn.itcast.controller.*.*(..)) &amp;&amp; @annotation(operateLog)"</span><span class="o">)</span>
   <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">insertLogAround</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span> <span class="o">,</span> <span class="nc">OperateLog</span> <span class="n">operateLog</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span><span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" ************************ 记录日志 [start]  ****************************** "</span><span class="o">);</span>
      
      <span class="nc">OperationLog</span> <span class="n">op</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OperationLog</span><span class="o">();</span>
      
      <span class="nc">DateFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">);</span>

      <span class="n">op</span><span class="o">.</span><span class="na">setOperateTime</span><span class="o">(</span><span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
      <span class="n">op</span><span class="o">.</span><span class="na">setOperateUser</span><span class="o">(</span><span class="nc">DataUtils</span><span class="o">.</span><span class="na">getRandStr</span><span class="o">(</span><span class="mi">8</span><span class="o">));</span>
      
      <span class="n">op</span><span class="o">.</span><span class="na">setOperateClass</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getTarget</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">op</span><span class="o">.</span><span class="na">setOperateMethod</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
      
      <span class="c1">//获取方法调用时传递的参数</span>
      <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
      <span class="n">op</span><span class="o">.</span><span class="na">setParamAndValue</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>

      <span class="kt">long</span> <span class="n">start_time</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

      <span class="c1">//放行</span>
      <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>

      <span class="kt">long</span> <span class="n">end_time</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
      <span class="n">op</span><span class="o">.</span><span class="na">setCostTime</span><span class="o">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="o">);</span>

      <span class="k">if</span><span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
         <span class="n">op</span><span class="o">.</span><span class="na">setReturnClass</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
         <span class="n">op</span><span class="o">.</span><span class="na">setReturnValue</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="o">}</span><span class="k">else</span><span class="o">{</span>
         <span class="n">op</span><span class="o">.</span><span class="na">setReturnClass</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">);</span>
         <span class="n">op</span><span class="o">.</span><span class="na">setParamAndValue</span><span class="o">(</span><span class="s">"void"</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="nc">JsonUtils</span><span class="o">.</span><span class="na">obj2JsonString</span><span class="o">(</span><span class="n">op</span><span class="o">));</span>

      <span class="n">operationLogService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">op</span><span class="o">);</span>
      
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" ************************** 记录日志 [end]  *************************** "</span><span class="o">);</span>
      
      <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
   <span class="o">}</span>
   
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="433-方法上加注解">4.3.3 方法上加注解</h5><p>在需要记录日志的方法上加上注解@OperateLog。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nd">@OperateLog</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/insert"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Result</span> <span class="nf">insert</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Brand</span> <span class="n">brand</span><span class="o">){</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">brandService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">brand</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="s">"操作成功"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="s">"操作失败"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="44-日志查询后端代码实现">4.4 日志查询后端代码实现</h4><h5 id="441-mapper接口">4.4.1 Mapper接口</h5><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OperationLogMapper</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">OperationLog</span> <span class="n">operationLog</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OperationLog</span><span class="o">&gt;</span> <span class="nf">selectListByCondition</span><span class="o">(</span><span class="nc">Map</span> <span class="n">dataMap</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">countByCondition</span><span class="o">(</span><span class="nc">Map</span> <span class="n">dataMap</span><span class="o">);</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="442-mapperxml-映射配置文件">4.4.2 Mapper.xml 映射配置文件</h5><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"cn.itcast.mapper.OperationLogMapper"</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insert"</span> <span class="na">parameterType=</span><span class="s">"operationLog"</span><span class="nt">&gt;</span>
        INSERT INTO operation_log(id,return_value,return_class,operate_user,operate_time,param_and_value,
        operate_class,operate_method,cost_time)
      VALUES(NULL,#{returnValue},#{returnClass},#{operateUser},#{operateTime},#{paramAndValue},
        #{operateClass},#{operateMethod},#{costTime})
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectListByCondition"</span> <span class="na">parameterType=</span><span class="s">"map"</span> <span class="na">resultType=</span><span class="s">"operationLog"</span><span class="nt">&gt;</span>
      select
        id ,
        operate_class as operateClass ,
        operate_method as operateMethod,
        return_class as returnClass,
        operate_user as operateUser,
        operate_time as operateTime,
        param_and_value as paramAndValue,
        cost_time as costTime,
        return_value as returnValue
      from operation_log
      <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"oplog_where"</span><span class="nt">/&gt;</span>
      limit #{start},#{size}
    <span class="nt">&lt;/select&gt;</span>


    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"countByCondition"</span> <span class="na">resultType=</span><span class="s">"long"</span> <span class="na">parameterType=</span><span class="s">"map"</span><span class="nt">&gt;</span>
        select count(*) from operation_log
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"oplog_where"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/select&gt;</span>


    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">"oplog_where"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;where&gt;</span>
            <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"operateClass != null and operateClass != '' "</span><span class="nt">&gt;</span>
                and operate_class = #{operateClass}
            <span class="nt">&lt;/if&gt;</span>
            <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"operateMethod != null and operateMethod != '' "</span><span class="nt">&gt;</span>
                and operate_method = #{operateMethod}
            <span class="nt">&lt;/if&gt;</span>
            <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"returnClass != null and returnClass != '' "</span><span class="nt">&gt;</span>
                and return_class = #{returnClass}
            <span class="nt">&lt;/if&gt;</span>
            <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"costTime != null"</span><span class="nt">&gt;</span>
                and cost_time =  #{costTime}
            <span class="nt">&lt;/if&gt;</span>
        <span class="nt">&lt;/where&gt;</span>
    <span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="443-service">4.4.3 Service</h5><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OperationLogService</span> <span class="o">{</span>

    <span class="c1">//private static Logger logger = Logger.getLogger(OperationLogService.class);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">OperationLogMapper</span> <span class="n">operationLogMapper</span><span class="o">;</span>

    <span class="c1">//插入数据</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">OperationLog</span> <span class="n">operationLog</span><span class="o">){</span>
        <span class="n">operationLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">operationLog</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//根据条件查询</span>
    <span class="kd">public</span> <span class="nc">PageResult</span> <span class="nf">selectListByCondition</span><span class="o">(</span><span class="nc">Map</span> <span class="n">dataMap</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">pageNum</span> <span class="o">,</span> <span class="nc">Integer</span> <span class="n">pageSize</span><span class="o">){</span>

       <span class="k">if</span><span class="o">(</span><span class="n">paramMap</span> <span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="n">paramMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">paramMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"start"</span> <span class="o">,</span> <span class="o">(</span><span class="n">pageNum</span><span class="o">-</span><span class="mi">1</span><span class="o">)*</span><span class="n">rows</span><span class="o">);</span>
        <span class="n">paramMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"rows"</span><span class="o">,</span><span class="n">rows</span><span class="o">);</span>

        <span class="nc">Object</span> <span class="n">costTime</span> <span class="o">=</span> <span class="n">paramMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"costTime"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">costTime</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">costTime</span><span class="o">.</span><span class="na">toString</span><span class="o">())){</span>
                <span class="n">paramMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"costTime"</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">paramMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"costTime"</span><span class="o">,</span><span class="k">new</span> <span class="nc">Long</span><span class="o">(</span><span class="n">paramMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"costTime"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataMap</span><span class="o">);</span>


        <span class="kt">long</span> <span class="n">countStart</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">Long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">operationLogMapper</span><span class="o">.</span><span class="na">countByCondition</span><span class="o">(</span><span class="n">dataMap</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">countEnd</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Count Cost Time : "</span> <span class="o">+</span> <span class="o">(</span><span class="n">countEnd</span><span class="o">-</span><span class="n">countStart</span><span class="o">)+</span><span class="s">" ms"</span><span class="o">);</span>


        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OperationLog</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">operationLogMapper</span><span class="o">.</span><span class="na">selectListByCondition</span><span class="o">(</span><span class="n">dataMap</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">queryEnd</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Query Cost Time : "</span> <span class="o">+</span> <span class="o">(</span><span class="n">queryEnd</span><span class="o">-</span><span class="n">countEnd</span><span class="o">)+</span><span class="s">" ms"</span><span class="o">);</span>


        <span class="k">return</span> <span class="k">new</span> <span class="nf">PageResult</span><span class="o">(</span><span class="n">count</span><span class="o">,</span><span class="n">list</span><span class="o">);</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="444-controller">4.4.4 Controller</h5><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/operationLog"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OperationLogController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">OperationLogService</span> <span class="n">operationLogService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/findList"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">PageResult</span> <span class="nf">findList</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Map</span> <span class="n">dataMap</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">pageNum</span> <span class="o">,</span> <span class="nc">Integer</span> <span class="n">pageSize</span><span class="o">){</span>
        <span class="nc">PageResult</span> <span class="n">page</span> <span class="o">=</span> <span class="n">operationLogService</span><span class="o">.</span><span class="na">selectListByCondition</span><span class="o">(</span><span class="n">dataMap</span><span class="o">,</span> <span class="n">pageNum</span><span class="o">,</span> <span class="n">pageSize</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="45-日志查询前端代码实现">4.5 日志查询前端代码实现</h4><p>前端代码使用 BootStrap + AdminLTE 进行布局， 使用Vuejs 进行视图层展示。</p><h5 id="451-js">4.5.1 js</h5><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
   <span class="kd">var</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
       <span class="na">el</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#app</span><span class="dl">'</span><span class="p">,</span>
       <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
           <span class="na">dataList</span><span class="p">:[],</span>
           <span class="na">searchEntity</span><span class="p">:{</span>
               <span class="na">operateClass</span><span class="p">:</span><span class="dl">''</span><span class="p">,</span>
               <span class="na">operateMethod</span><span class="p">:</span><span class="dl">''</span><span class="p">,</span>
               <span class="na">returnClass</span><span class="p">:</span><span class="dl">''</span><span class="p">,</span>
               <span class="na">costTime</span><span class="p">:</span><span class="dl">''</span>
           <span class="p">},</span>

           <span class="na">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1">//显示的是哪一页</span>
           <span class="na">pageSize</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">//每一页显示的数据条数</span>
           <span class="na">total</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="c1">//记录总数</span>
           <span class="na">maxPage</span><span class="p">:</span><span class="mi">8</span>  <span class="c1">//最大页数</span>
       <span class="p">},</span>
       <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
           <span class="na">pageHandler</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">page</span> <span class="o">=</span> <span class="nx">page</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">search</span><span class="p">();</span>
           <span class="p">},</span>

           <span class="na">search</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">();</span>
               <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/operationLog/findList.do?pageNum=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">page</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;pageSize=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">searchEntity</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                   <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                       <span class="nx">_this</span><span class="p">.</span><span class="nx">dataList</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">dataList</span><span class="p">;</span>
                       <span class="nx">_this</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">total</span><span class="p">;</span>
                       <span class="nx">_this</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">();</span>
                   <span class="p">}</span>
               <span class="p">})</span>
           <span class="p">},</span>

           <span class="na">showLoading</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
               <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loadingModal</span><span class="dl">'</span><span class="p">).</span><span class="nx">modal</span><span class="p">({</span><span class="na">backdrop</span><span class="p">:</span> <span class="dl">'</span><span class="s1">static</span><span class="dl">'</span><span class="p">,</span> <span class="na">keyboard</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>
           <span class="p">},</span>

           <span class="na">hideLoading</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
               <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loadingModal</span><span class="dl">'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="dl">'</span><span class="s1">hide</span><span class="dl">'</span><span class="p">);</span>
           <span class="p">},</span>
       <span class="p">},</span>

       <span class="na">created</span><span class="p">:</span><span class="kd">function</span><span class="p">(){</span>
           <span class="k">this</span><span class="p">.</span><span class="nx">pageHandler</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
       <span class="p">}</span>
   <span class="p">});</span>

<span class="nt">&lt;/script&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="452-列表数据展示">4.5.2 列表数据展示</h5><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;tr</span> <span class="na">v-for=</span><span class="s">"item in dataList"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"ids"</span> <span class="na">type=</span><span class="s">"checkbox"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"btn bg-olive btn-xs"</span><span class="nt">&gt;</span>详情<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"btn bg-olive btn-xs"</span><span class="nt">&gt;</span>删除<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>4.5.3 分页插件</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrap"</span> <span class="na">id=</span><span class="s">"wrap"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;zpagenav</span> <span class="na">v-bind:page=</span><span class="s">"page"</span> <span class="na">v-bind:page-size=</span><span class="s">"pageSize"</span> <span class="na">v-bind:total=</span><span class="s">"total"</span>
              <span class="na">v-bind:max-page=</span><span class="s">"maxPage"</span>  <span class="na">v-on:pagehandler=</span><span class="s">"pageHandler"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/zpagenav&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="46-联调测试">4.6 联调测试</h4><p>可以通过postman来访问业务系统，再查看数据库中的日志信息，验证能不能将用户的访问日志记录下来。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555077276426.png" alt="1555077276426"></p><h4 id="47-分析性能问题">4.7 分析性能问题</h4><p>系统中用户访问日志的数据量，随着时间的推移，这张表的数据量会越来越大，因此我们需要根据业务需求，来对日志查询模块的性能进行优化。</p><p>1） 分页查询优化</p><p>由于在进行日志查询时，是进行分页查询，那也就意味着，在查看时，至少需要查询两次：</p><p>A. 查询符合条件的总记录数。--&gt; count 操作</p><p>B. 查询符合条件的列表数据。--&gt; 分页查询 limit 操作</p><p>通常来说，count() 都需要扫描大量的行（意味着需要访问大量的数据）才能获得精确的结果，因此是很难对该SQL进行优化操作的。如果需要对count进行优化，可以采用另外一种思路，可以增加汇总表，或者redis缓存来专门记录该表对应的记录数，这样的话，就可以很轻松的实现汇总数据的查询，而且效率很高，但是这种统计并不能保证百分之百的准确 。对于数据库的操作，“快速、精确、实现简单”，三者永远只能满足其二，必须舍掉其中一个。</p><p>2） 条件查询优化</p><p>针对于条件查询,需要对查询条件,及排序字段建立索引。</p><p>3） 读写分离</p><p>通过主从复制集群，来完成读写分离，使写操作走主节点， 而读操作，走从节点。</p><p>4） MySQL服务器优化</p><p>5） 应用优化</p><h4 id="48-性能优化---分页">4.8 性能优化 - 分页</h4><h5 id="481-优化count">4.8.1 优化count</h5><p>创建一张表用来记录日志表的总数据量：</p><pre><code class="language-SQL">create table log_counter(
	logcount bigint not null
)engine = innodb default CHARSET = utf8;
</code></pre><p>在每次插入数据之后，更新该表 ：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">"updateLogCounter"</span> <span class="nt">&gt;</span>
    update log_counter set logcount = logcount + 1
<span class="nt">&lt;/update&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>在进行分页查询时, 获取总记录数，从该表中查询既可。</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"countLogFromCounter"</span> <span class="na">resultType=</span><span class="s">"long"</span><span class="nt">&gt;</span>
    select logcount from log_counter limit 1
<span class="nt">&lt;/select&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="482-优化-limit">4.8.2 优化 limit</h5><p>在进行分页时，一般通过创建覆盖索引，能够比较好的提高性能。一个非常常见，而又非常头疼的分页场景就是 “limit 1000000,10” ，此时MySQL需要搜索出前1000010 条记录后，仅仅需要返回第 1000001 到 1000010 条记录，前1000000 记录会被抛弃，查询代价非常大。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555081714638.png" alt="1555081714638"></p><p>当点击比较靠后的页码时，就会出现这个问题，查询效率非常慢。</p><p>优化SQL：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">operation_log</span> <span class="k">limit</span> <span class="mi">3000000</span> <span class="p">,</span> <span class="mi">10</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>将上述SQL优化为 :</p><pre><code class="language-SQL">select * from operation_log t , (select id from operation_log order by id limit 3000000,10) b where t.id = b.id ;
</code></pre><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectListByCondition"</span> <span class="na">parameterType=</span><span class="s">"map"</span> <span class="na">resultType=</span><span class="s">"operationLog"</span><span class="nt">&gt;</span>
  select
    id ,
    operate_class as operateClass ,
    operate_method as operateMethod,
    return_class as returnClass,
    operate_user as operateUser,
    operate_time as operateTime,
    param_and_value as paramAndValue,
    cost_time as costTime,
    return_value as returnValue
  from operation_log t,
    
  (select id from operation_log 
  <span class="nt">&lt;where&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"oplog_where"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/where&gt;</span>
  order by id limit #{start},#{rows}) b  where t.id = b.id  
<span class="nt">&lt;/select&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="49-性能优化---索引">4.9 性能优化 - 索引</h4><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555152703824.png" alt="1555152703824"></p><p>当根据操作人进行查询时， 查询的效率很低，耗时比较长。原因就是因为在创建数据库表结构时，并没有针对于 操作人 字段建立索引。</p><pre><code class="language-SQL">CREATE INDEX idx_user_method_return_cost ON operation_log(operate_user,operate_method,return_class,cost_time);
</code></pre><p>同上 ， 为了查询效率高，我们也需要对 操作方法、返回值类型、操作耗时 等字段进行创建索引，以提高查询效率。</p><pre><code class="language-SQL">CREATE INDEX idx_optlog_method_return_cost ON operation_log(operate_method,return_class,cost_time);

CREATE INDEX idx_optlog_return_cost ON operation_log(return_class,cost_time);

CREATE INDEX idx_optlog_cost ON operation_log(cost_time);

</code></pre><h4 id="410-性能优化---排序">4.10 性能优化 - 排序</h4><p>在查询数据时，如果业务需求中需要我们对结果内容进行了排序处理 , 这个时候,我们还需要对排序的字段建立适当的索引, 来提高排序的效率 。</p><h4 id="411-性能优化---读写分离">4.11 性能优化 - 读写分离</h4><h5 id="4111-概述">4.11.1 概述</h5><p>在Mysql主从复制的基础上，可以使用读写分离来降低单台Mysql节点的压力，从而来提高访问效率，读写分离的架构如下：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555235426739.png" alt="1555235426739"></p><p>对于读写分离的实现，可以通过Spring AOP 来进行动态的切换数据源，进行操作 ：</p><h5 id="4112-实现方式">4.11.2 实现方式</h5><p>db.properties</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="py">jdbc.write.driver</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">jdbc.write.url</span><span class="p">=</span><span class="s">jdbc:mysql://192.168.142.128:3306/mysql_demo</span>
<span class="py">jdbc.write.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">jdbc.write.password</span><span class="p">=</span><span class="s">itcast</span>

<span class="py">jdbc.read.driver</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">jdbc.read.url</span><span class="p">=</span><span class="s">jdbc:mysql://192.168.142.129:3306/mysql_demo</span>
<span class="py">jdbc.read.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">jdbc.read.password</span><span class="p">=</span><span class="s">itcast</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>applicationContext-datasource.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>


    <span class="c">&lt;!-- 配置数据源 - Read --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"readDataSource"</span> <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="na">destroy-method=</span><span class="s">"close"</span>  <span class="na">lazy-init=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClass"</span> <span class="na">value=</span><span class="s">"${jdbc.read.driver}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"${jdbc.read.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">value=</span><span class="s">"${jdbc.read.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.read.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>


    <span class="c">&lt;!-- 配置数据源 - Write --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"writeDataSource"</span> <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>  <span class="na">destroy-method=</span><span class="s">"close"</span>  <span class="na">lazy-init=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClass"</span> <span class="na">value=</span><span class="s">"${jdbc.write.driver}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"${jdbc.write.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">value=</span><span class="s">"${jdbc.write.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.write.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>


    <span class="c">&lt;!-- 配置动态分配的读写 数据源 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"cn.itcast.aop.datasource.ChooseDataSource"</span> <span class="na">lazy-init=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"targetDataSources"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map</span> <span class="na">key-type=</span><span class="s">"java.lang.String"</span> <span class="na">value-type=</span><span class="s">"javax.sql.DataSource"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"write"</span> <span class="na">value-ref=</span><span class="s">"writeDataSource"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"read"</span> <span class="na">value-ref=</span><span class="s">"readDataSource"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>

        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"defaultTargetDataSource"</span> <span class="na">ref=</span><span class="s">"writeDataSource"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"methodType"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map</span> <span class="na">key-type=</span><span class="s">"java.lang.String"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"read"</span> <span class="na">value=</span><span class="s">",get,select,count,list,query,find"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"write"</span> <span class="na">value=</span><span class="s">",add,create,update,delete,remove,insert"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>ChooseDataSource</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChooseDataSource</span> <span class="kd">extends</span> <span class="nc">AbstractRoutingDataSource</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="no">METHOD_TYPE_MAP</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;();</span>

    <span class="cm">/**
     * 实现父类中的抽象方法，获取数据源名称
     * @return
     */</span>
    <span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DataSourceHandler</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 设置方法名前缀对应的数据源</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMethodType</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">types</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">type</span> <span class="o">:</span> <span class="n">types</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">v</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="no">METHOD_TYPE_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"METHOD_TYPE_MAP : "</span><span class="o">+</span><span class="no">METHOD_TYPE_MAP</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>DataSourceHandler</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceHandler</span> <span class="o">{</span>

    <span class="c1">// 数据源名称</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>

    <span class="cm">/**
     * 在项目启动的时候将配置的读、写数据源加到holder中
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">putDataSource</span><span class="o">(</span><span class="nc">String</span> <span class="n">datasource</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">datasource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 从holer中获取数据源字符串
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getDataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">holder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>DataSourceAspect</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(-</span><span class="mi">9999</span><span class="o">)</span>
<span class="nd">@EnableAspectJAutoProxy</span><span class="o">(</span><span class="n">proxyTargetClass</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceAspect</span> <span class="o">{</span>

    <span class="kd">protected</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

    <span class="cm">/**
     * 配置前置通知,使用在方法aspect()上注册的切入点
     */</span>
    <span class="nd">@Before</span><span class="o">(</span><span class="s">"execution(* cn.itcast.service.*.*(..))"</span><span class="o">)</span>
    <span class="nd">@Order</span><span class="o">(-</span><span class="mi">9999</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">point</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getTarget</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">className</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">point</span><span class="o">.</span><span class="na">getArgs</span><span class="o">())+</span> <span class="s">")"</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">key</span> <span class="o">:</span> <span class="nc">ChooseDataSource</span><span class="o">.</span><span class="na">METHOD_TYPE_MAP</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">type</span> <span class="o">:</span> <span class="nc">ChooseDataSource</span><span class="o">.</span><span class="na">METHOD_TYPE_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"key : "</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
                        <span class="nc">DataSourceHandler</span><span class="o">.</span><span class="na">putDataSource</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>通过 @Order(-9999) 注解来控制事务管理器, 与该通知类的加载顺序 , 需要让通知类 , 先加载 , 来判定使用哪个数据源 .</p><h5 id="4113-验证">4.11.3 验证</h5><p>在主库和从库中，执行如下SQL语句，来查看是否读的时候， 从从库中读取 ； 写入操作的时候，是否写入到主库。</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">show</span> <span class="n">status</span> <span class="k">like</span> <span class="s1">'Innodb_rows_%'</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><img src="../../img/in-post/2020-9-14-mysql/assets4/1555235982584.png" alt="1555235982584"></p><h5 id="4114-原理">4.11.4 原理</h5><p><img src="../../img/in-post/2020-9-14-mysql/assets4/aop-datasource.png" alt="1555235982584"></p><h4 id="412-性能优化---应用优化">4.12 性能优化 - 应用优化</h4><h5 id="4121-缓存">4.12.1 缓存</h5><p>可以在业务系统中使用redis来做缓存，缓存一些基础性的数据，来降低关系型数据库的压力，提高访问效率。</p><h5 id="4122-全文检索">4.12.2 全文检索</h5><p>如果业务系统中的数据量比较大（达到千万级别），这个时候，如果再对数据库进行查询，特别是进行分页查询，速度将变得很慢（因为在分页时首先需要count求合计数），为了提高访问效率，这个时候，可以考虑加入Solr 或者 ElasticSearch全文检索服务，来提高访问效率。</p><h5 id="4133-非关系数据库">4.13.3 非关系数据库</h5><p>也可以考虑将非核心（重要）数据，存在 MongoDB 中，这样可以提高插入以及查询的效率。</p><hr style="visibility:hidden"><ul class="pager"><li class="previous"><a href="/mysql-note-a03.html" data-toggle="tooltip" data-placement="top" title="MySQL学习笔记高级篇（三）">Previous<br><span>MySQL学习笔记高级篇（三）</span></a></li><li class="next"><a href="/h5-ping-tu-1.html" data-toggle="tooltip" data-placement="top" title="h5拼图小游戏">Next<br><span>h5拼图小游戏</span></a></li></ul><hr style="visibility:hidden"><link rel="stylesheet" href="/css/gitalk.css"><script src="/js/gitalk.min.js"></script><script src="/js/md5.min.js"></script><div class="row"><div id="gitalk-container"></div></div></div><div class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"><div class="side-catalog"><hr class="hidden-sm hidden-xs"><h5><a class="catalog-toggle" href="#">CATALOG</a></h5><ul class="catalog-body"></ul></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><div class="dropdown navbar-form navbar-right"><input id="search-input" name="word" type="text" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown" class="form-control typeahead" placeholder="搜索"><ul class="dropdown-menu" aria-labelledby="dLabel" id="results-container"></ul></div><script src="/js/simple-jekyll-search.js" type="text/javascript"></script><script>window.simpleJekyllSearch=new SimpleJekyllSearch({searchInput:document.getElementById("search-input"),resultsContainer:document.getElementById("results-container"),json:"/search.json",searchResultTemplate:'<li><a href="{url}" title="{desc}">{title}</a></li>',noResultsText:"没有搜索到文章",limit:20,fuzzy:!0})</script><section><hr class="hidden-sm hidden-xs"><h5><a href="/archive/">FEATURED TAGS</a></h5><div class="tags"><a data-sort="0023" href="/archive/?tag=Linux" title="Linux" rel="3">Linux</a> <a data-sort="0018" href="/archive/?tag=cpp" title="cpp" rel="8">cpp</a> <a data-sort="0020" href="/archive/?tag=%E5%90%8E%E7%AB%AF" title="后端" rel="6">后端</a> <a data-sort="0020" href="/archive/?tag=%E7%AE%97%E6%B3%95" title="算法" rel="6">算法</a> <a data-sort="0022" href="/archive/?tag=%E6%80%A7%E8%83%BD" title="性能" rel="4">性能</a> <a data-sort="0022" href="/archive/?tag=%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" title="数据结构" rel="4">数据结构</a> <a data-sort="0022" href="/archive/?tag=mysql" title="mysql" rel="4">mysql</a> <a data-sort="0024" href="/archive/?tag=%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8" title="信息安全" rel="2">信息安全</a> <a data-sort="0024" href="/archive/?tag=%E5%89%8D%E7%AB%AF" title="前端" rel="2">前端</a> <a data-sort="0024" href="/archive/?tag=java" title="java" rel="2">java</a> <a data-sort="0024" href="/archive/?tag=kali" title="kali" rel="2">kali</a> <a data-sort="0024" href="/archive/?tag=linux" title="linux" rel="2">linux</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://2084team.cn/">2084 Team</a></li></ul></div></div></div></article><script>var gitalk=new Gitalk({clientID:"23a9781cae2172c5d591",clientSecret:"4493f8b5c72f024f1a7b79d556b7e43599f918ed",repo:"czqu.github.io",owner:"czqu",admin:["czqu"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("gitalk-container")</script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("/js/anchor.min.js",function(){anchors.options={visible:"hover",placement:"right"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a id="rss" href="/feed.xml"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/czqu"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li><li><a target="_blank" href="https://blog.csdn.net/weixin_44409903"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">C</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Czq's Blog 2021<br><a id="switchsite" href="https://blog.czqu.ren/">国内访问</a> &nbsp; &nbsp;&nbsp; <a href="/license.html">许可协议 License</a><br><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">&nbsp;本站总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;次&nbsp;</span><span id="busuanzi_container_site_uv"> &nbsp;访客数&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;人次</span><script type="text/javascript">var linkobj=document.getElementById("switchsite");current_url=window.location.href,is_global?(target_url=replacedomain(current_url,document.domain,"blog.czqu.ren"),linkobj.href=target_url,linkobj.innerText="国内访问"):(target_url=replacedomain(current_url,document.domain,"czqu.cc"),linkobj.href=target_url,linkobj.innerText="海外访问")</script></p></div></div></div></footer><script src="/js/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/hux-blog.min.js"></script><script src="/js/snackbar.js"></script><script src="/js/sw-registration.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("/js/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _gaId="UA-171260366-1",_gaDomain="czqu.cc";_gaDomain=is_global?(_gaId="UA-171260366-1","czqu.cc"):(_gaId="UA-171260366-2","blog.czqu.ren"),function(a,e,g,c,n,o,t){a.GoogleAnalyticsObject=n,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,o=e.createElement(g),t=e.getElementsByTagName(g)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",t.parentNode.insertBefore(o,t)}(window,document,"script",0,"ga"),ga("create",_gaId,_gaDomain),ga("send","pageview")</script><script>var _baId="202567f05f85026a62a117eec19b4a09",linkobj=document.getElementById("switchsite");_baId=is_global?"202567f05f85026a62a117eec19b4a09":"496677e3ceac55257d74003c6c3c2f3b";var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(e,a)}()</script><script type="text/javascript">function generateCatalog(e){var a,l,n,t,o,c;return _containerSelector="div.post-container",a=$(_containerSelector).find("h1,h2,h3,h4,h5,h6"),$(e).html(""),a.each(function(){l=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),c=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),t=$('<li class="'+l+'_nav"></li>').append(c),$(e).append(t)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),async("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><img src="/img/icon_wechat.png" width="0" height="0"></body></html>