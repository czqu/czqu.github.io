<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="description" content="1. Linux 系统安装MySQL
"><meta name="keywords" content="czq's Blog,  博客, 个人网站, 互联网, java,Linux,Web"><meta name="theme-color" content="#000000"><meta property="og:title" content="MySQL学习笔记高级篇（一） - Czq's Blog"><meta property="og:type" content="article"><meta property="og:description" content="1. Linux 系统安装MySQL
"><meta property="article:published_time" content="2020-09-14T16:00:00Z"><meta property="article:author" content="陈子琦"><meta property="article:tag" content="mysql"><meta property="article:tag" content="后端"><meta property="article:tag" content="性能"><meta property="og:image" content="https://czqu.cc/img/avatar-boy.webp"><meta property="og:url" content="https://czqu.cc/mysql-note-a01.html"><meta property="og:site_name" content="Czq's Blog"><title>MySQL学习笔记高级篇（一） - Czq's Blog</title><link rel="manifest" href="/pwa/manifest.json"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://czqu.cc/mysql-note-a01.html"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/hux-blog.min.css"><link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><script></script></head><body ontouchstart=""><script src="/js/qin-blog.js" type="text/javascript"></script><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Czq's Blog</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archive/">Archive</a></li><li><a href="/more/">More</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(e){0<$navbar.className.indexOf("in")?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){e.target!=$toggle&&"icon-bar"!=e.target.className&&__HuxNav__.close()})</script><style type="text/css">header.intro-header{position:relative;background-image:url(/img/home-bg-notdimmed.webp)}</style><header class="intro-header"><div class="header-mask"></div><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/archive/?tag=mysql" title="mysql">mysql</a> <a class="tag" href="/archive/?tag=%E5%90%8E%E7%AB%AF" title="后端">后端</a> <a class="tag" href="/archive/?tag=%E6%80%A7%E8%83%BD" title="性能">性能</a></div><h1>MySQL学习笔记高级篇（一）</h1><h2 class="subheading"></h2><span class="meta">Posted by 陈子琦 on September 14, 2020</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><h3 id="1-linux-系统安装mysql">1. Linux 系统安装MySQL</h3><h4 id="11-下载linux-安装包">1.1 下载Linux 安装包</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>https://dev.mysql.com/downloads/mysql/5.7.html#downloads
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="12-安装mysql">1.2 安装MySQL</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>1). 卸载 centos 中预安装的 mysql
	
	rpm -qa | grep -i mysql
	
	rpm -e mysql-libs-5.1.71-1.el6.x86_64 --nodeps
	
2). 上传 mysql 的安装包
	
	alt + p -------&gt; put  E:/test/MySQL-5.6.22-1.el6.i686.rpm-bundle.tar

3). 解压 mysql 的安装包 
	
	mkdir mysql
	
	tar -xvf MySQL-5.6.22-1.el6.i686.rpm-bundle.tar -C /root/mysql
	
4). 安装依赖包 
	
	yum -y install libaio.so.1 libgcc_s.so.1 libstdc++.so.6 libncurses.so.5 --setopt=protected_multilib=false
	
	yum  update libstdc++-4.4.7-4.el6.x86_64
	
5). 安装 mysql-client
	
	rpm -ivh MySQL-client-5.6.22-1.el6.i686.rpm

6). 安装 mysql-server
	
	rpm -ivh MySQL-server-5.6.22-1.el6.i686.rpm
	
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="13-启动-mysql-服务">1.3 启动 MySQL 服务</h4><pre><code class="language-SQL">service mysql start

service mysql stop

service mysql status

service mysql restart
</code></pre><h4 id="14-登录mysql">1.4 登录MySQL</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>mysql 安装完成之后, 会自动生成一个随机的密码, 并且保存在一个密码文件中 : /root/.mysql_secret

mysql -u root -p 

登录之后, 修改密码 :

set password = password('itcast');

授权远程访问 : 

grant all privileges on *.* to 'root' @'%' identified by 'itcast';
flush privileges;

</pre></td></tr></tbody></table></code></pre></div></div><h3 id="2-索引">2. 索引</h3><h4 id="21-索引概述">2.1 索引概述</h4><p>MySQL官方对索引的定义为：索引（index）是帮助MySQL高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护者满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。如下面的==示意图==所示 :</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555902055367.png" alt="1555902055367"></p><p>左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址（注意逻辑上相邻的记录在磁盘上也并不是一定物理相邻的）。为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找快速获取到相应数据。</p><p>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。索引是数据库中用来提高性能的最常用的工具。</p><h4 id="22-索引优势劣势">2.2 索引优势劣势</h4><p>优势</p><p>1） 类似于书籍的目录索引，提高数据检索的效率，降低数据库的IO成本。</p><p>2） 通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗。</p><p>劣势</p><p>1） 实际上索引也是一张表，该表中保存了主键与索引字段，并指向实体类的记录，所以索引列也是要占用空间的。</p><p>2） 虽然索引大大提高了查询效率，同时却也降低更新表的速度，如对表进行INSERT、UPDATE、DELETE。因为更新表时，MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</p><h4 id="23-索引结构">2.3 索引结构</h4><p>索引是在MySQL的存储引擎层中实现的，而不是在服务器层实现的。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型的。MySQL目前提供了以下4种索引：</p><ul><li>BTREE 索引 ： 最常见的索引类型，大部分索引都支持 B 树索引。</li><li>HASH 索引：只有Memory引擎支持 ， 使用场景简单 。</li><li>R-tree 索引（空间索引）：空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少，不做特别介绍。</li><li>Full-text （全文索引） ：全文索引也是MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从Mysql5.6版本开始支持全文索引。</li></ul><center><b>MyISAM、InnoDB、Memory三种存储引擎对各种索引类型的支持</b></center><table><thead><tr><th>索引</th><th>InnoDB引擎</th><th>MyISAM引擎</th><th>Memory引擎</th></tr></thead><tbody><tr><td>BTREE索引</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>HASH 索引</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>R-tree 索引</td><td>不支持</td><td>支持</td><td>不支持</td></tr><tr><td>Full-text</td><td>5.6版本之后支持</td><td>支持</td><td>不支持</td></tr></tbody></table><p>我们平常所说的索引，如果没有特别指明，都是指B+树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引、复合索引、前缀索引、唯一索引默认都是使用 B+tree 索引，统称为 索引。</p><h5 id="231-btree-结构">2.3.1 BTREE 结构</h5><p>BTree又叫多路平衡搜索树，一颗m叉的BTree特性如下：</p><ul><li>树中每个节点最多包含m个孩子。</li><li>除根节点与叶子节点外，每个节点至少有[ceil(m/2)]个孩子。</li><li>若根节点不是叶子节点，则至少有两个孩子。</li><li>所有的叶子节点都在同一层。</li><li>每个非叶子节点由n个key与n+1个指针组成，其中[ceil(m/2)-1] &lt;= n &lt;= m-1</li></ul><p>以5叉BTree为例，key的数量：公式推导[ceil(m/2)-1] &lt;= n &lt;= m-1。所以 2 &lt;= n &lt;=4 。当n&gt;4时，中间节点分裂到父节点，两边节点分裂。</p><p>插入 C N G A H E K Q M F W L T Z D P R X Y S 数据为例。</p><p>演变过程如下：</p><p>1). 插入前4个字母 C N G A</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944126588.png" alt="1555944126588"></p><p>2). 插入H，n&gt;4，中间元素G字母向上分裂到新的节点</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944549825.png" alt="1555944549825"></p><p>3). 插入E，K，Q不需要分裂</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944596893.png" alt="1555944596893"></p><p>4). 插入M，中间元素M字母向上分裂到父节点G</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944652560.png" alt="1555944652560"></p><p>5). 插入F，W，L，T不需要分裂</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944686928.png" alt="1555944686928"></p><p>6). 插入Z，中间元素T向上分裂到父节点中</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944713486.png" alt="1555944713486"></p><p>7). 插入D，中间元素D向上分裂到父节点中。然后插入P，R，X，Y不需要分裂</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944749984.png" alt="1555944749984"></p><p>8). 最后插入S，NPQR节点n&gt;5，中间节点Q向上分裂，但分裂后父节点DGMT的n&gt;5，中间节点M向上分裂</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555944848294.png" alt="1555944848294"></p><p>到此，该BTREE树就已经构建完成了， BTREE树 和 二叉树 相比， 查询数据的效率更高， 因为对于相同的数据量来说，BTREE的层级结构比二叉树小，因此搜索速度快。</p><h5 id="232-btree-结构">2.3.2 B+TREE 结构</h5><p>B+Tree为BTree的变种，B+Tree与BTree的区别为：</p><p>1). n叉B+Tree最多含有n个key，而BTree最多含有n-1个key。</p><p>2). B+Tree的叶子节点保存所有的key信息，依key大小顺序排列。</p><p>3). 所有的非叶子节点都可以看作是key的索引部分。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1.jpg" alt="1555906287178"></p><p>由于B+Tree只有叶子节点保存key信息，查询任何key都要从root走到叶子。所以B+Tree的查询效率更加稳定。</p><h5 id="233-mysql中的btree">2.3.3 MySQL中的B+Tree</h5><p>MySql索引数据结构对经典的B+Tree进行了优化。在原B+Tree的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的B+Tree，提高区间访问的性能。</p><p>MySQL中的 B+Tree 索引结构示意图:</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1555906287178.png" alt="1555906287178"></p><h4 id="24-索引分类">2.4 索引分类</h4><p>1） 单值索引 ：即一个索引只包含单个列，一个表可以有多个单列索引</p><p>2） 唯一索引 ：索引列的值必须唯一，但允许有空值</p><p>3） 复合索引 ：即一个索引包含多个列</p><h4 id="25-索引语法">2.5 索引语法</h4><p>索引在创建表的时候，可以同时创建， 也可以随时增加新的索引。</p><p>准备环境:</p><pre><code class="language-SQL">create database demo_01 default charset=utf8mb4;

use demo_01;

CREATE TABLE `city` (
  `city_id` int(11) NOT NULL AUTO_INCREMENT,
  `city_name` varchar(50) NOT NULL,
  `country_id` int(11) NOT NULL,
  PRIMARY KEY (`city_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `country` (
  `country_id` int(11) NOT NULL AUTO_INCREMENT,
  `country_name` varchar(100) NOT NULL,
  PRIMARY KEY (`country_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


insert into `city` (`city_id`, `city_name`, `country_id`) values(1,'西安',1);
insert into `city` (`city_id`, `city_name`, `country_id`) values(2,'NewYork',2);
insert into `city` (`city_id`, `city_name`, `country_id`) values(3,'北京',1);
insert into `city` (`city_id`, `city_name`, `country_id`) values(4,'上海',1);

insert into `country` (`country_id`, `country_name`) values(1,'China');
insert into `country` (`country_id`, `country_name`) values(2,'America');
insert into `country` (`country_id`, `country_name`) values(3,'Japan');
insert into `country` (`country_id`, `country_name`) values(4,'UK');
</code></pre><h5 id="251-创建索引">2.5.1 创建索引</h5><p>语法 ：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> 	<span class="p">[</span><span class="k">UNIQUE</span><span class="o">|</span><span class="n">FULLTEXT</span><span class="o">|</span><span class="n">SPATIAL</span><span class="p">]</span>  <span class="k">INDEX</span> <span class="n">index_name</span> 
<span class="p">[</span><span class="k">USING</span>  <span class="n">index_type</span><span class="p">]</span>
<span class="k">ON</span> <span class="n">tbl_name</span><span class="p">(</span><span class="n">index_col_name</span><span class="p">,...)</span>


<span class="n">index_col_name</span> <span class="p">:</span> <span class="k">column_name</span><span class="p">[(</span><span class="k">length</span><span class="p">)][</span><span class="k">ASC</span> <span class="o">|</span> <span class="k">DESC</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 ： 为city表中的city_name字段创建索引 ；</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551438009843.png" alt="1551438009843"> ​</p><p>​</p><h5 id="252-查看索引">2.5.2 查看索引</h5><p>语法：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>show index  from  table_name;
</pre></td></tr></tbody></table></code></pre></div></div><p>示例：查看city表中的索引信息；</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551440511890.png" alt="1551440511890"></p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551440544483.png" alt="1551440544483"></p><h5 id="253-删除索引">2.5.3 删除索引</h5><p>语法 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>DROP  INDEX  index_name  ON  tbl_name;
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 ： 想要删除city表上的索引idx_city_name，可以操作如下：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551438238293.png" alt="1551438238293"></p><h5 id="254-alter命令">2.5.4 ALTER命令</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>1). alter  table  tb_name  add  primary  key(column_list); 

	该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL
	
2). alter  table  tb_name  add  unique index_name(column_list);
	
	这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）
	
3). alter  table  tb_name  add  index index_name(column_list);

	添加普通索引， 索引值可以出现多次。
	
4). alter  table  tb_name  add  fulltext  index_name(column_list);
	
	该语句指定了索引为FULLTEXT， 用于全文索引
	
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="26-索引设计原则">2.6 索引设计原则</h4><p>​	索引的设计可以遵循一些已有的原则，创建索引的时候请尽量考虑符合这些原则，便于提升索引的使用效率，更高效的使用索引。</p><ul><li><p>对查询频次较高，且数据量比较大的表建立索引。</p></li><li><p>索引字段的选择，最佳候选列应当从where子句的条件中提取，如果where子句中的组合比较多，那么应当挑选最常用、过滤效果最好的列的组合。</p></li><li><p>使用唯一索引，区分度越高，使用索引的效率越高。</p></li><li><p>索引可以有效的提升查询数据的效率，但索引数量不是多多益善，索引越多，维护索引的代价自然也就水涨船高。对于插入、更新、删除等DML操作比较频繁的表来说，索引过多，会引入相当高的维护代价，降低DML操作的效率，增加相应操作的时间消耗。另外索引过多的话，MySQL也会犯选择困难病，虽然最终仍然会找到一个可用的索引，但无疑提高了选择的代价。</p></li><li><p>使用短索引，索引创建之后也是使用硬盘来存储的，因此提升索引访问的I/O效率，也可以提升总体的访问效率。假如构成索引的字段总长度比较短，那么在给定大小的存储块内可以存储更多的索引值，相应的可以有效的提升MySQL访问索引的I/O效率。</p></li><li><p>利用最左前缀，N个列组合而成的组合索引，那么相当于是创建了N个索引，如果查询时where子句中使用了组成该索引的前几个字段，那么这条查询SQL可以利用组合索引来提升查询效率。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>创建复合索引:
  
	CREATE INDEX idx_name_email_status ON tb_seller(NAME,email,STATUS);
  
就相当于
	对name 创建索引 ;
	对name , email 创建了索引 ;
	对name , email, status 创建了索引 ;
</pre></td></tr></tbody></table></code></pre></div></div></li></ul><h3 id="3-视图">3. 视图</h3><h4 id="31-视图概述">3.1 视图概述</h4><p>​	视图（View）是一种虚拟存在的表。视图并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视图时动态生成的。通俗的讲，视图就是一条SELECT语句执行后返回的结果集。所以我们在创建视图的时候，主要的工作就落在创建这条SQL查询语句上。</p><p>视图相对于普通的表的优势主要包括以下几项。</p><ul><li>简单：使用视图的用户完全不需要关心后面对应的表的结构、关联条件和筛选条件，对用户来说已经是过滤好的复合条件的结果集。</li><li>安全：使用视图的用户只能访问他们被允许查询的结果集，对表的权限管理并不能限制到某个行某个列，但是通过视图就可以简单的实现。</li><li>数据独立：一旦视图的结构确定了，可以屏蔽表结构变化对用户的影响，源表增加列对视图没有影响；源表修改列名，则可以通过修改视图来解决，不会造成对访问者的影响。</li></ul><h4 id="32-创建或者修改视图">3.2 创建或者修改视图</h4><p>创建视图的语法为：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="p">[</span><span class="k">OR</span> <span class="k">REPLACE</span><span class="p">]</span> <span class="p">[</span><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="err">{</span><span class="n">UNDEFINED</span> <span class="o">|</span> <span class="n">MERGE</span> <span class="o">|</span> <span class="n">TEMPTABLE</span><span class="err">}</span><span class="p">]</span>

<span class="k">VIEW</span> <span class="n">view_name</span> <span class="p">[(</span><span class="n">column_list</span><span class="p">)]</span>

<span class="k">AS</span> <span class="n">select_statement</span>

<span class="p">[</span><span class="k">WITH</span> <span class="p">[</span><span class="k">CASCADED</span> <span class="o">|</span> <span class="k">LOCAL</span><span class="p">]</span> <span class="k">CHECK</span> <span class="k">OPTION</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>修改视图的语法为：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">ALTER</span> <span class="p">[</span><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="err">{</span><span class="n">UNDEFINED</span> <span class="o">|</span> <span class="n">MERGE</span> <span class="o">|</span> <span class="n">TEMPTABLE</span><span class="err">}</span><span class="p">]</span>

<span class="k">VIEW</span> <span class="n">view_name</span> <span class="p">[(</span><span class="n">column_list</span><span class="p">)]</span>

<span class="k">AS</span> <span class="n">select_statement</span>

<span class="p">[</span><span class="k">WITH</span> <span class="p">[</span><span class="k">CASCADED</span> <span class="o">|</span> <span class="k">LOCAL</span><span class="p">]</span> <span class="k">CHECK</span> <span class="k">OPTION</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>选项 : 
	WITH [CASCADED | LOCAL] CHECK OPTION 决定了是否允许更新数据使记录不再满足视图的条件。
	
	LOCAL ： 只要满足本视图的条件就可以更新。
	CASCADED ： 必须满足所有针对该视图的所有视图的条件才可以更新。 默认值.
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 , 创建city_country_view视图 , 执行如下SQL :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">view</span> <span class="n">city_country_view</span> 
<span class="k">as</span> 
<span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="k">c</span><span class="p">.</span><span class="n">country_name</span> <span class="k">from</span> <span class="n">country</span> <span class="k">c</span> <span class="p">,</span> <span class="n">city</span> <span class="n">t</span> <span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">country_id</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">country_id</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></pre></div></div><p>查询视图 :</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551503428635.png" alt="1551503428635"></p><h4 id="33-查看视图">3.3 查看视图</h4><p>​	从 MySQL 5.1 版本开始，使用 SHOW TABLES 命令的时候不仅显示表的名字，同时也会显示视图的名字，而不存在单独显示视图的 SHOW VIEWS 命令。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551537565159.png" alt="1551537565159"></p><p>同样，在使用 SHOW TABLE STATUS 命令的时候，不但可以显示表的信息，同时也可以显示视图的信息。</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551537646323.png" alt="1551537646323"></p><p>如果需要查询某个视图的定义，可以使用 SHOW CREATE VIEW 命令进行查看 ：</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1551588962944.png" alt="1551588962944"></p><h4 id="34-删除视图">3.4 删除视图</h4><p>语法 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">DROP</span> <span class="k">VIEW</span> <span class="p">[</span><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="n">view_name</span> <span class="p">[,</span> <span class="n">view_name</span><span class="p">]</span> <span class="p">...[</span><span class="k">RESTRICT</span> <span class="o">|</span> <span class="k">CASCADE</span><span class="p">]</span>	
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 , 删除视图city_country_view :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>DROP VIEW city_country_view ;
</pre></td></tr></tbody></table></code></pre></div></div><h3 id="4-存储过程和函数">4. 存储过程和函数</h3><h4 id="41-存储过程和函数概述">4.1 存储过程和函数概述</h4><p>​	存储过程和函数是 事先经过编译并存储在数据库中的一段 SQL 语句的集合，调用存储过程和函数可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。</p><p>​	存储过程和函数的区别在于函数必须有返回值，而存储过程没有。</p><p>​	函数 ： 是一个有返回值的过程 ；</p><p>​	过程 ： 是一个没有返回值的函数 ；</p><h4 id="42-创建存储过程">4.2 创建存储过程</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">procedure_name</span> <span class="p">([</span><span class="n">proc_parameter</span><span class="p">[,...]])</span>
<span class="k">begin</span>
	<span class="c1">-- SQL语句</span>
<span class="k">end</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 ：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test1</span><span class="p">()</span>
<span class="k">begin</span>
	<span class="k">select</span> <span class="s1">'Hello Mysql'</span> <span class="p">;</span>
<span class="k">end</span><span class="err">$</span>

<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><strong><font color="red">知识小贴士</font></strong></p><p>DELIMITER</p><p>​	该关键字用来声明SQL语句的分隔符 , 告诉 MySQL 解释器，该段命令是否已经结束了，mysql是否可以执行了。默认情况下，delimiter是分号;。在命令行客户端中，如果有一行命令以分号结束，那么回车后，mysql将会执行该命令。</p><h4 id="43-调用存储过程">4.3 调用存储过程</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">call</span> <span class="n">procedure_name</span><span class="p">()</span> <span class="p">;</span>	
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="44-查看存储过程">4.4 查看存储过程</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">-- 查询db_name数据库中的所有的存储过程</span>
<span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">mysql</span><span class="p">.</span><span class="n">proc</span> <span class="k">where</span> <span class="n">db</span><span class="o">=</span><span class="s1">'db_name'</span><span class="p">;</span>


<span class="c1">-- 查询存储过程的状态信息</span>
<span class="k">show</span> <span class="k">procedure</span> <span class="n">status</span><span class="p">;</span>


<span class="c1">-- 查询某个存储过程的定义</span>
<span class="k">show</span> <span class="k">create</span> <span class="k">procedure</span> <span class="n">test</span><span class="p">.</span><span class="n">pro_test1</span> <span class="err">\</span><span class="k">G</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="45-删除存储过程">4.5 删除存储过程</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">DROP</span> <span class="k">PROCEDURE</span>  <span class="p">[</span><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="n">sp_name</span> <span class="err">；</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="46-语法">4.6 语法</h4><p>存储过程是可以编程的，意味着可以使用变量，表达式，控制结构 ， 来完成比较复杂的功能。</p><h5 id="461-变量">4.6.1 变量</h5><ul><li>DECLARE</li></ul><p>通过 DECLARE 可以定义一个局部变量，该变量的作用范围只能在 BEGIN…END 块中。</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">DECLARE</span> <span class="n">var_name</span><span class="p">[,...]</span> <span class="k">type</span> <span class="p">[</span><span class="k">DEFAULT</span> <span class="n">value</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre> <span class="k">delimiter</span> <span class="err">$</span>

 <span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test2</span><span class="p">()</span> 
 <span class="k">begin</span> 
 	<span class="k">declare</span> <span class="n">num</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">5</span><span class="p">;</span>
 	<span class="k">select</span> <span class="n">num</span><span class="o">+</span> <span class="mi">10</span><span class="p">;</span> 
 <span class="k">end</span><span class="err">$</span>

 <span class="k">delimiter</span> <span class="p">;</span> 
</pre></td></tr></tbody></table></code></pre></div></div><ul><li>SET</li></ul><p>直接赋值使用 SET，可以赋常量或者赋表达式，具体语法如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  SET var_name = expr [, var_name = expr] ...
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  <span class="k">DELIMITER</span> <span class="err">$</span>
  
  <span class="k">CREATE</span>  <span class="k">PROCEDURE</span> <span class="n">pro_test3</span><span class="p">()</span>
  <span class="k">BEGIN</span>
  	<span class="k">DECLARE</span> <span class="n">NAME</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
  	<span class="k">SET</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s1">'MYSQL'</span><span class="p">;</span>
  	<span class="k">SELECT</span> <span class="n">NAME</span> <span class="p">;</span>
  <span class="k">END</span><span class="err">$</span>
  
  <span class="k">DELIMITER</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>也可以通过select ... into 方式进行赋值操作 :</p><pre><code class="language-SQL">DELIMITER $

CREATE  PROCEDURE pro_test5()
BEGIN
	declare  countnum int;
	select count(*) into countnum from city;
	select countnum;
END$

DELIMITER ;
</code></pre><h5 id="462-if条件判断">4.6.2 if条件判断</h5><p>语法结构 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">if</span> <span class="n">search_condition</span> <span class="k">then</span> <span class="n">statement_list</span>

	<span class="p">[</span><span class="n">elseif</span> <span class="n">search_condition</span> <span class="k">then</span> <span class="n">statement_list</span><span class="p">]</span> <span class="p">...</span>
	
	<span class="p">[</span><span class="k">else</span> <span class="n">statement_list</span><span class="p">]</span>
	
<span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>需求：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>根据定义的身高变量，判定当前身高的所属的身材类型 

	180 及以上 ----------&gt; 身材高挑

	170 - 180  ---------&gt; 标准身材

	170 以下  ----------&gt; 一般身材
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test6</span><span class="p">()</span>
<span class="k">begin</span>
  <span class="k">declare</span>  <span class="n">height</span>  <span class="nb">int</span>  <span class="k">default</span>  <span class="mi">175</span><span class="p">;</span> 
  <span class="k">declare</span>  <span class="n">description</span>  <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  
  <span class="n">if</span>  <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">180</span>  <span class="k">then</span>
    <span class="k">set</span> <span class="n">description</span> <span class="o">=</span> <span class="s1">'身材高挑'</span><span class="p">;</span>
  <span class="n">elseif</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">170</span> <span class="k">and</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">180</span>  <span class="k">then</span>
    <span class="k">set</span> <span class="n">description</span> <span class="o">=</span> <span class="s1">'标准身材'</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">set</span> <span class="n">description</span> <span class="o">=</span> <span class="s1">'一般身材'</span><span class="p">;</span>
  <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
  
  <span class="k">select</span> <span class="n">description</span> <span class="p">;</span>
<span class="k">end</span><span class="err">$</span>

<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>调用结果为 :</p><p><img src="../../img/in-post/2020-9-14-mysql/assets1/1552057035580.png" alt="1552057035580"></p><h5 id="463-传递参数">4.6.3 传递参数</h5><p>语法格式 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>create procedure procedure_name([in/out/inout] 参数名   参数类型)
...


IN :   该参数可以作为输入，也就是需要调用方传入值 , 默认
OUT:   该参数作为输出，也就是该参数可以作为返回值
INOUT: 既可以作为输入参数，也可以作为输出参数
</pre></td></tr></tbody></table></code></pre></div></div><p><strong>IN - 输入</strong></p><p>需求 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>根据定义的身高变量，判定当前身高的所属的身材类型 
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test5</span><span class="p">(</span><span class="k">in</span> <span class="n">height</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">begin</span>
    <span class="k">declare</span> <span class="n">description</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">default</span> <span class="s1">''</span><span class="p">;</span>
  <span class="n">if</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">180</span> <span class="k">then</span>
    <span class="k">set</span> <span class="n">description</span><span class="o">=</span><span class="s1">'身材高挑'</span><span class="p">;</span>
  <span class="n">elseif</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">170</span> <span class="k">and</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="k">then</span>
    <span class="k">set</span> <span class="n">description</span><span class="o">=</span><span class="s1">'标准身材'</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">set</span> <span class="n">description</span><span class="o">=</span><span class="s1">'一般身材'</span><span class="p">;</span>
  <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
  <span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="s1">'身高 '</span><span class="p">,</span> <span class="n">height</span> <span class="p">,</span> <span class="s1">'对应的身材类型为:'</span><span class="p">,</span><span class="n">description</span><span class="p">);</span>
<span class="k">end</span><span class="err">$</span>

<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p><strong>OUT-输出</strong></p><p>需求 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>根据传入的身高变量，获取当前身高的所属的身材类型  
</pre></td></tr></tbody></table></code></pre></div></div><p>示例:</p><pre><code class="language-SQL">create procedure pro_test5(in height int , out description varchar(100))
begin
  if height &gt;= 180 then
    set description='身材高挑';
  elseif height &gt;= 170 and height &lt; 180 then
    set description='标准身材';
  else
    set description='一般身材';
  end if;
end$	
</code></pre><p>调用:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>call pro_test5(168, @description)$

select @description$
</pre></td></tr></tbody></table></code></pre></div></div><font color="red">**小知识** </font><p>@description : 这种变量要在变量名称前面加上“@”符号，叫做用户会话变量，代表整个会话过程他都是有作用的，这个类似于全局变量一样。</p><p>@@global.sort_buffer_size : 这种在变量前加上 “@@” 符号, 叫做 系统变量</p><h5 id="464-case结构">4.6.4 case结构</h5><p>语法结构 :</p><pre><code class="language-SQL">方式一 : 

CASE case_value

  WHEN when_value THEN statement_list
  
  [WHEN when_value THEN statement_list] ...
  
  [ELSE statement_list]
  
END CASE;


方式二 : 

CASE

  WHEN search_condition THEN statement_list
  
  [WHEN search_condition THEN statement_list] ...
  
  [ELSE statement_list]
  
END CASE;

</code></pre><p>需求:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>给定一个月份, 然后计算出所在的季度
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>


<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test9</span><span class="p">(</span><span class="k">month</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">begin</span>
  <span class="k">declare</span> <span class="k">result</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
  <span class="k">case</span> 
    <span class="k">when</span> <span class="k">month</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">and</span> <span class="k">month</span> <span class="o">&lt;=</span><span class="mi">3</span> <span class="k">then</span> 
      <span class="k">set</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">'第一季度'</span><span class="p">;</span>
    <span class="k">when</span> <span class="k">month</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">and</span> <span class="k">month</span> <span class="o">&lt;=</span><span class="mi">6</span> <span class="k">then</span> 
      <span class="k">set</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">'第二季度'</span><span class="p">;</span>
    <span class="k">when</span> <span class="k">month</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="k">and</span> <span class="k">month</span> <span class="o">&lt;=</span><span class="mi">9</span> <span class="k">then</span> 
      <span class="k">set</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">'第三季度'</span><span class="p">;</span>
    <span class="k">when</span> <span class="k">month</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">and</span> <span class="k">month</span> <span class="o">&lt;=</span><span class="mi">12</span> <span class="k">then</span> 
      <span class="k">set</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">'第四季度'</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">case</span><span class="p">;</span>
  
  <span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="s1">'您输入的月份为 :'</span><span class="p">,</span> <span class="k">month</span> <span class="p">,</span> <span class="s1">' , 该月份为 : '</span> <span class="p">,</span> <span class="k">result</span><span class="p">)</span> <span class="k">as</span> <span class="n">content</span> <span class="p">;</span>
  
<span class="k">end</span><span class="err">$</span>


<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="465-while循环">4.6.5 while循环</h5><p>语法结构:</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">while</span> <span class="n">search_condition</span> <span class="k">do</span>

	<span class="n">statement_list</span>
	
<span class="k">end</span> <span class="n">while</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>需求:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>计算从1加到n的值
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test8</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">begin</span>
  <span class="k">declare</span> <span class="n">total</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">declare</span> <span class="n">num</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">while</span> <span class="n">num</span><span class="o">&lt;=</span><span class="n">n</span> <span class="k">do</span>
    <span class="k">set</span> <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">set</span> <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">end</span> <span class="n">while</span><span class="p">;</span>
  <span class="k">select</span> <span class="n">total</span><span class="p">;</span>
<span class="k">end</span><span class="err">$</span>

<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="466-repeat结构">4.6.6 repeat结构</h5><p>有条件的循环控制语句, 当满足条件的时候退出循环 。while 是满足条件才执行，repeat 是满足条件就退出循环。</p><p>语法结构 :</p><pre><code class="language-SQL">REPEAT

  statement_list

  UNTIL search_condition

END REPEAT;
</code></pre><p>需求:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>计算从1加到n的值
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test10</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">begin</span>
  <span class="k">declare</span> <span class="n">total</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">repeat</span> 
    <span class="k">set</span> <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">set</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">until</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>  
  <span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
  
  <span class="k">select</span> <span class="n">total</span> <span class="p">;</span>
  
<span class="k">end</span><span class="err">$</span>


<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="467-loop语句">4.6.7 loop语句</h5><p>LOOP 实现简单的循环，退出循环的条件需要使用其他的语句定义，通常可以使用 LEAVE 语句实现，具体语法如下：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">begin_label</span><span class="p">:]</span> <span class="n">LOOP</span>

  <span class="n">statement_list</span>

<span class="k">END</span> <span class="n">LOOP</span> <span class="p">[</span><span class="n">end_label</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>如果不在 statement_list 中增加退出循环的语句，那么 LOOP 语句可以用来实现简单的死循环。</p><h5 id="468-leave语句">4.6.8 leave语句</h5><p>用来从标注的流程构造中退出，通常和 BEGIN ... END 或者循环一起使用。下面是一个使用 LOOP 和 LEAVE 的简单例子 , 退出循环：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">delimiter</span> <span class="err">$</span>

<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">pro_test11</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">BEGIN</span>
  <span class="k">declare</span> <span class="n">total</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">ins</span><span class="p">:</span> <span class="n">LOOP</span>
    
    <span class="n">IF</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
      <span class="n">leave</span> <span class="n">ins</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
    
    <span class="k">set</span> <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">set</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  	
  <span class="k">END</span> <span class="n">LOOP</span> <span class="n">ins</span><span class="p">;</span>
  
  <span class="k">select</span> <span class="n">total</span><span class="p">;</span>
<span class="k">END</span><span class="err">$</span>

<span class="k">delimiter</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h5 id="469-游标光标">4.6.9 游标/光标</h5><p>游标是用来存储查询结果集的数据类型 , 在存储过程和函数中可以使用光标对结果集进行循环的处理。光标的使用包括光标的声明、OPEN、FETCH 和 CLOSE，其语法分别如下。</p><p>声明光标：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">DECLARE</span> <span class="k">cursor_name</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="n">select_statement</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>OPEN 光标：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">OPEN</span> <span class="k">cursor_name</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>FETCH 光标：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">FETCH</span> <span class="k">cursor_name</span> <span class="k">INTO</span> <span class="n">var_name</span> <span class="p">[,</span> <span class="n">var_name</span><span class="p">]</span> <span class="p">...</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>CLOSE 光标：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">CLOSE</span> <span class="k">cursor_name</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>示例 :</p><p>初始化脚本:</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">emp</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span> <span class="p">,</span>
  <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'姓名'</span><span class="p">,</span>
  <span class="n">age</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">comment</span> <span class="s1">'年龄'</span><span class="p">,</span>
  <span class="n">salary</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">comment</span> <span class="s1">'薪水'</span><span class="p">,</span>
  <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span> <span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">emp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">salary</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'金毛狮王'</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">3800</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">'白眉鹰王'</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">4000</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">'青翼蝠王'</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">2800</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">'紫衫龙王'</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">1800</span><span class="p">);</span>

</pre></td></tr></tbody></table></code></pre></div></div><pre><code class="language-SQL">-- 查询emp表中数据, 并逐行获取进行展示
create procedure pro_test11()
begin
  declare e_id int(11);
  declare e_name varchar(50);
  declare e_age int(11);
  declare e_salary int(11);
  declare emp_result cursor for select * from emp;
  
  open emp_result;
  
  fetch emp_result into e_id,e_name,e_age,e_salary;
  select concat('id=',e_id , ', name=',e_name, ', age=', e_age, ', 薪资为: ',e_salary);
  
  fetch emp_result into e_id,e_name,e_age,e_salary;
  select concat('id=',e_id , ', name=',e_name, ', age=', e_age, ', 薪资为: ',e_salary);
  
  fetch emp_result into e_id,e_name,e_age,e_salary;
  select concat('id=',e_id , ', name=',e_name, ', age=', e_age, ', 薪资为: ',e_salary);
  
  fetch emp_result into e_id,e_name,e_age,e_salary;
  select concat('id=',e_id , ', name=',e_name, ', age=', e_age, ', 薪资为: ',e_salary);
  
  fetch emp_result into e_id,e_name,e_age,e_salary;
  select concat('id=',e_id , ', name=',e_name, ', age=', e_age, ', 薪资为: ',e_salary);
  
  close emp_result;
end$

</code></pre><p>通过循环结构 , 获取游标中的数据 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">DELIMITER</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_test12</span><span class="p">()</span>
<span class="k">begin</span>
  <span class="k">DECLARE</span> <span class="n">id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
  <span class="k">DECLARE</span> <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  <span class="k">DECLARE</span> <span class="n">age</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
  <span class="k">DECLARE</span> <span class="n">salary</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
  <span class="k">DECLARE</span> <span class="n">has_data</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="k">DECLARE</span> <span class="n">emp_result</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">emp</span><span class="p">;</span>
  <span class="k">DECLARE</span> <span class="n">EXIT</span> <span class="k">HANDLER</span> <span class="k">FOR</span> <span class="k">NOT</span> <span class="k">FOUND</span> <span class="k">set</span> <span class="n">has_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="k">open</span> <span class="n">emp_result</span><span class="p">;</span>
  
  <span class="n">repeat</span>
    <span class="k">fetch</span> <span class="n">emp_result</span> <span class="k">into</span> <span class="n">id</span> <span class="p">,</span> <span class="n">name</span> <span class="p">,</span> <span class="n">age</span> <span class="p">,</span> <span class="n">salary</span><span class="p">;</span>
    <span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="s1">'id为'</span><span class="p">,</span><span class="n">id</span><span class="p">,</span> <span class="s1">', name 为'</span> <span class="p">,</span><span class="n">name</span> <span class="p">,</span> <span class="s1">', age为 '</span> <span class="p">,</span><span class="n">age</span> <span class="p">,</span> <span class="s1">', 薪水为: '</span><span class="p">,</span> <span class="n">salary</span><span class="p">);</span>
    <span class="k">until</span> <span class="n">has_data</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
  
  <span class="k">close</span> <span class="n">emp_result</span><span class="p">;</span>
<span class="k">end</span><span class="err">$</span>

<span class="k">DELIMITER</span> <span class="p">;</span> 
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="47-存储函数">4.7 存储函数</h4><p>语法结构:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>CREATE FUNCTION function_name([param type ... ]) 
RETURNS type 
BEGIN
	...
END;
</pre></td></tr></tbody></table></code></pre></div></div><p>案例 :</p><p>定义一个存储过程, 请求满足条件的总记录数 ;</p><pre><code class="language-SQL">
delimiter $

create function count_city(countryId int)
returns int
begin
  declare cnum int ;
  
  select count(*) into cnum from city where country_id = countryId;
  
  return cnum;
end$

delimiter ;
</code></pre><p>调用:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>select count_city(1);

select count_city(2);
</pre></td></tr></tbody></table></code></pre></div></div><h3 id="5-触发器">5. 触发器</h3><h4 id="51-介绍">5.1 介绍</h4><p>触发器是与表有关的数据库对象，指在 insert/update/delete 之前或之后，触发并执行触发器中定义的SQL语句集合。触发器的这种特性可以协助应用在数据库端确保数据的完整性 , 日志记录 , 数据校验等操作 。</p><p>使用别名 OLD 和 NEW 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句级触发。</p><table><thead><tr><th>触发器类型</th><th>NEW 和 OLD的使用</th></tr></thead><tbody><tr><td>INSERT 型触发器</td><td>NEW 表示将要或者已经新增的数据</td></tr><tr><td>UPDATE 型触发器</td><td>OLD 表示修改之前的数据 , NEW 表示将要或已经修改后的数据</td></tr><tr><td>DELETE 型触发器</td><td>OLD 表示将要或者已经删除的数据</td></tr></tbody></table><h4 id="52-创建触发器">5.2 创建触发器</h4><p>语法结构 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">trigger</span> <span class="k">trigger_name</span> 

<span class="k">before</span><span class="o">/</span><span class="k">after</span> <span class="k">insert</span><span class="o">/</span><span class="k">update</span><span class="o">/</span><span class="k">delete</span>

<span class="k">on</span> <span class="n">tbl_name</span> 

<span class="p">[</span> <span class="k">for</span> <span class="k">each</span> <span class="k">row</span> <span class="p">]</span>  <span class="c1">-- 行级触发器</span>

<span class="k">begin</span>

	<span class="n">trigger_stmt</span> <span class="p">;</span>

<span class="k">end</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>示例</p><p>需求</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>通过触发器记录 emp 表的数据变更日志 , 包含增加, 修改 , 删除 ;
</pre></td></tr></tbody></table></code></pre></div></div><p>首先创建一张日志表 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">emp_logs</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span><span class="p">,</span>
  <span class="k">operation</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'操作类型, insert/update/delete'</span><span class="p">,</span>
  <span class="n">operate_time</span> <span class="nb">datetime</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'操作时间'</span><span class="p">,</span>
  <span class="n">operate_id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'操作表的ID'</span><span class="p">,</span>
  <span class="n">operate_params</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">comment</span> <span class="s1">'操作参数'</span><span class="p">,</span>
  <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>创建 insert 型触发器，完成插入数据时的日志记录 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">DELIMITER</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">trigger</span> <span class="n">emp_logs_insert_trigger</span>
<span class="k">after</span> <span class="k">insert</span> 
<span class="k">on</span> <span class="n">emp</span> 
<span class="k">for</span> <span class="k">each</span> <span class="k">row</span> 
<span class="k">begin</span>
  <span class="k">insert</span> <span class="k">into</span> <span class="n">emp_logs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="k">operation</span><span class="p">,</span><span class="n">operate_time</span><span class="p">,</span><span class="n">operate_id</span><span class="p">,</span><span class="n">operate_params</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'insert'</span><span class="p">,</span><span class="n">now</span><span class="p">(),</span><span class="k">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="s1">'插入后(id:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="s1">', name:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="s1">', age:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="s1">', salary:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="s1">')'</span><span class="p">));</span>	
<span class="k">end</span> <span class="err">$</span>

<span class="k">DELIMITER</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>创建 update 型触发器，完成更新数据时的日志记录 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">DELIMITER</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">trigger</span> <span class="n">emp_logs_update_trigger</span>
<span class="k">after</span> <span class="k">update</span> 
<span class="k">on</span> <span class="n">emp</span> 
<span class="k">for</span> <span class="k">each</span> <span class="k">row</span> 
<span class="k">begin</span>
  <span class="k">insert</span> <span class="k">into</span> <span class="n">emp_logs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="k">operation</span><span class="p">,</span><span class="n">operate_time</span><span class="p">,</span><span class="n">operate_id</span><span class="p">,</span><span class="n">operate_params</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'update'</span><span class="p">,</span><span class="n">now</span><span class="p">(),</span><span class="k">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="s1">'修改前(id:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="s1">', name:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="s1">', age:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="s1">', salary:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="s1">') , 修改后(id'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">'name:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="s1">', age:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="s1">', salary:'</span><span class="p">,</span><span class="k">new</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="s1">')'</span><span class="p">));</span>                                                                      
<span class="k">end</span> <span class="err">$</span>

<span class="k">DELIMITER</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>创建delete 行的触发器 , 完成删除数据时的日志记录 :</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">DELIMITER</span> <span class="err">$</span>

<span class="k">create</span> <span class="k">trigger</span> <span class="n">emp_logs_delete_trigger</span>
<span class="k">after</span> <span class="k">delete</span> 
<span class="k">on</span> <span class="n">emp</span> 
<span class="k">for</span> <span class="k">each</span> <span class="k">row</span> 
<span class="k">begin</span>
  <span class="k">insert</span> <span class="k">into</span> <span class="n">emp_logs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="k">operation</span><span class="p">,</span><span class="n">operate_time</span><span class="p">,</span><span class="n">operate_id</span><span class="p">,</span><span class="n">operate_params</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">'delete'</span><span class="p">,</span><span class="n">now</span><span class="p">(),</span><span class="k">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="s1">'删除前(id:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="s1">', name:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="s1">', age:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="s1">', salary:'</span><span class="p">,</span><span class="k">old</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="s1">')'</span><span class="p">));</span>                                                                      
<span class="k">end</span> <span class="err">$</span>

<span class="k">DELIMITER</span> <span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>测试：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">insert</span> <span class="k">into</span> <span class="n">emp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">salary</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'光明左使'</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">3500</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">emp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">salary</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'光明右使'</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">3200</span><span class="p">);</span>

<span class="k">update</span> <span class="n">emp</span> <span class="k">set</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">39</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="k">delete</span> <span class="k">from</span> <span class="n">emp</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="53-删除触发器">5.3 删除触发器</h4><p>语法结构 :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>drop trigger [schema_name.]trigger_name
</pre></td></tr></tbody></table></code></pre></div></div><p>如果没有指定 schema_name，默认为当前数据库 。</p><h4 id="54-查看触发器">5.4 查看触发器</h4><p>可以通过执行 SHOW TRIGGERS 命令查看触发器的状态、语法等信息。</p><p>语法结构 ：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>show triggers ；
</pre></td></tr></tbody></table></code></pre></div></div><hr style="visibility:hidden"><ul class="pager"><li class="previous"><a href="/algorithm/binary-search.html" data-toggle="tooltip" data-placement="top" title="算法与数据结构学习笔记：二分法">Previous<br><span>算法与数据结构学习笔记：二分法</span></a></li><li class="next"><a href="/mysql-note-a02.html" data-toggle="tooltip" data-placement="top" title="MySQL学习笔记高级篇（二）">Next<br><span>MySQL学习笔记高级篇（二）</span></a></li></ul><hr style="visibility:hidden"><link rel="stylesheet" href="../css/gitalk.css"><script src="../js/gitalk.min.js"></script><script src="../js/md5.min.js"></script><div class="row"><div id="gitalk-container"></div></div></div><div class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"><div class="side-catalog"><hr class="hidden-sm hidden-xs"><h5><a class="catalog-toggle" href="#">CATALOG</a></h5><ul class="catalog-body"></ul></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><div class="dropdown navbar-form navbar-right"><input id="search-input" name="word" type="text" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown" class="form-control typeahead" placeholder="搜索"><ul class="dropdown-menu" aria-labelledby="dLabel" id="results-container"></ul></div><script src="/js/simple-jekyll-search.js" type="text/javascript"></script><script>window.simpleJekyllSearch=new SimpleJekyllSearch({searchInput:document.getElementById("search-input"),resultsContainer:document.getElementById("results-container"),json:"/search.json",searchResultTemplate:'<li><a href="{url}" title="{desc}">{title}</a></li>',noResultsText:"没有搜索到文章",limit:20,fuzzy:!0})</script><section><hr class="hidden-sm hidden-xs"><h5><a href="/archive/">FEATURED TAGS</a></h5><div class="tags"><a data-sort="0023" href="/archive/?tag=Linux" title="Linux" rel="3">Linux</a> <a data-sort="0018" href="/archive/?tag=cpp" title="cpp" rel="8">cpp</a> <a data-sort="0020" href="/archive/?tag=%E5%90%8E%E7%AB%AF" title="后端" rel="6">后端</a> <a data-sort="0020" href="/archive/?tag=%E7%AE%97%E6%B3%95" title="算法" rel="6">算法</a> <a data-sort="0022" href="/archive/?tag=%E6%80%A7%E8%83%BD" title="性能" rel="4">性能</a> <a data-sort="0022" href="/archive/?tag=%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" title="数据结构" rel="4">数据结构</a> <a data-sort="0022" href="/archive/?tag=mysql" title="mysql" rel="4">mysql</a> <a data-sort="0024" href="/archive/?tag=%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8" title="信息安全" rel="2">信息安全</a> <a data-sort="0024" href="/archive/?tag=%E5%89%8D%E7%AB%AF" title="前端" rel="2">前端</a> <a data-sort="0024" href="/archive/?tag=java" title="java" rel="2">java</a> <a data-sort="0024" href="/archive/?tag=kali" title="kali" rel="2">kali</a> <a data-sort="0024" href="/archive/?tag=linux" title="linux" rel="2">linux</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://2084team.cn/">2084 Team</a></li></ul></div></div></div></article><script>if(is_global)document.getElementById("gitalk-container").style.display="none";else{var gitalk=new Gitalk({clientID:"23a9781cae2172c5d591",clientSecret:"4493f8b5c72f024f1a7b79d556b7e43599f918ed",repo:"czqu.github.io",owner:"czqu",admin:["czqu"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("gitalk-container")}</script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("/js/anchor.min.js",function(){anchors.options={visible:"hover",placement:"right"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a id="rss" href="/feed.xml"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/czqu"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li><li><a target="_blank" href="https://blog.csdn.net/weixin_44409903"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">C</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Czq's Blog 2020<br><a id="switchsite" href="https://blog.xiyuan.ren/">国内访问</a> &nbsp; &nbsp;&nbsp; <a href="/license.html">许可协议 License</a><br><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">&nbsp;本站总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;次&nbsp;</span><span id="busuanzi_container_site_uv"> &nbsp;访客数&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;人次</span><script type="text/javascript">var linkobj=document.getElementById("switchsite");current_url=window.location.href,is_global?(target_url=replacedomain(current_url,document.domain,"blog.czqu.ren"),linkobj.href=target_url,linkobj.innerText="国内访问"):(target_url=replacedomain(current_url,document.domain,"czqu.cc"),linkobj.href=target_url,linkobj.innerText="海外访问")</script></p></div></div></div></footer><script src="/js/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/hux-blog.min.js"></script><script src="/js/snackbar.js"></script><script src="/js/sw-registration.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("/js/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _gaId="UA-171260366-1",_gaDomain="czqu.cc";_gaDomain=is_global?(_gaId="UA-171260366-1","czqu.cc"):(_gaId="UA-171260366-2","blog.czqu.ren"),function(a,e,g,c,n,o,t){a.GoogleAnalyticsObject=n,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,o=e.createElement(g),t=e.getElementsByTagName(g)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",t.parentNode.insertBefore(o,t)}(window,document,"script",0,"ga"),ga("create",_gaId,_gaDomain),ga("send","pageview")</script><script>var _baId="202567f05f85026a62a117eec19b4a09",linkobj=document.getElementById("switchsite");_baId=is_global?"202567f05f85026a62a117eec19b4a09":"496677e3ceac55257d74003c6c3c2f3b";var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(e,a)}()</script><script type="text/javascript">function generateCatalog(e){var a,l,n,t,o,c;return _containerSelector="div.post-container",a=$(_containerSelector).find("h1,h2,h3,h4,h5,h6"),$(e).html(""),a.each(function(){l=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),c=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),t=$('<li class="'+l+'_nav"></li>').append(c),$(e).append(t)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),async("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><img src="/img/icon_wechat.png" width="0" height="0"></body></html>